<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Tracker Pro - Portofolio & Keuntungan</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Vue.js CDN (3.x) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Load ApexCharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="./firebase-app.js"></script>
    <script src="./firebase-database.js"></script>
    <script src="./firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html, body {
            height: 100%;
            min-height: 100vh;
            width: 100%;
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        body {
            margin: 0;
        }
        .text-green-600 { color: #10b981; }
        .text-red-600 { color: #ef4444; }
        .text-yellow-600 { color: #f59e0b; }
        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease;
        }
        body.dark {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        .dark .bg-white { background-color: #374151 !important; }
        .dark .text-gray-900 { color: #f3f4f6 !important; }
        .dark .bg-gray-100 { background-color: #4b5563 !important; }
        .dark input, .dark textarea, .dark select {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #f3ff46;
        }
        .dark table {
            border-color: #4b5563;
        }
        @media (max-width: 640px) {
            .table-header-mobile {
                display: none;
            }
            .table-cell-responsive {
                display: block;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                text-align: right;
                border-bottom: 1px solid #e5e7eb;
            }
            .table-row-group > tr {
                margin-bottom: 1rem;
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 0.5rem;
            }
            .table-cell-responsive::before {
                content: attr(data-label);
                float: left;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.75rem;
                color: #6b7280;
            }
        }
        .fullwidth-app-container {
            max-width: 100vw;
            width: 100vw;
            padding-left: 1rem;
            padding-right: 1rem;
            box-sizing: border-box;
        }
        @media (min-width:640px) {
            .fullwidth-app-container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }
        @media (min-width:1024px) {
            .fullwidth-app-container {
                padding-left: 3.5rem;
                padding-right: 3.5rem;
            }
        }
        .cardgrid-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 1rem;
        }
        .cardgrid-summary .summarycard { min-width: 0; }
        .cardgrid-summary .summarycard:nth-child(1),
        .cardgrid-summary .summarycard:nth-child(2),
        .cardgrid-summary .summarycard:nth-child(3) {
            grid-row: 1;
        }
        .cardgrid-summary .summarycard:nth-child(1) {
            grid-column: 1;
        }
        .cardgrid-summary .summarycard:nth-child(2) {
            grid-column: 2;
        }
        .cardgrid-summary .summarycard:nth-child(3) {
            grid-column: 1 / 3;
        }
        .cardgrid-summary .summarycard:nth-child(4) {
            grid-row: 2;
            grid-column: 1;
        }
        .cardgrid-summary .summarycard:nth-child(5) {
            grid-row: 2;
            grid-column: 2;
        }
        @media (min-width: 768px) {
            .cardgrid-summary {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(2, auto);
            }
            .cardgrid-summary .summarycard:nth-child(1) {
                grid-row: 1; grid-column: 1;
            }
            .cardgrid-summary .summarycard:nth-child(2) {
                grid-row: 1; grid-column: 2;
            }
            .cardgrid-summary .summarycard:nth-child(3) {
                grid-row: 1; grid-column: 3;
            }
            .cardgrid-summary .summarycard:nth-child(4) {
                grid-row: 2; grid-column: 1 / span 2;
            }
            .cardgrid-summary .summarycard:nth-child(5) {
                grid-row: 2; grid-column: 3;
            }
        }
        @media (max-width: 480px) {
            .cardgrid-summary {
                grid-template-columns: 1fr;
                grid-template-rows: none;
            }
            .cardgrid-summary .summarycard { grid-column: 1; }
        }
        .summarycard p {
            white-space: normal;
            overflow-wrap: anywhere;
        }
    </style>
</head>
<body id="app" class="transition-colors duration-300">

    <div class="fullwidth-app-container">
        <!-- Header & Control Panel -->
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl transition-colors duration-300 card">
            <h1 class="text-3xl font-bold text-gray-900 mb-4 transition-colors duration-300">
                üí∞ Bitcoin Portfolio Tracker Pro
            </h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <!-- Current Price Display -->
                <div>
                    <p class="text-xs mt-1 text-gray-500 flex items-center space-x-2">
                        <span>
                            *Terakhir di-fetch: {{ lastFetchedTime }}
                        </span>
                        <button @click="fetchBitcoinPrice"
                            class="ml-2 inline-flex items-center px-2 py-1 border border-gray-300 bg-green-500 text-white text-xs font-medium rounded hover:bg-green-600 focus:outline-none transition ease-in-out duration-150"
                            title="Refresh Harga BTC">
                            Refresh
                        </button>
                    </p>
                    <div class="mt-1 flex rounded-md shadow-sm space-x-2">
                        <input
                            type="number"
                            step="0.01"
                            v-model="currentPriceInput"
                            @keyup.enter="updateManualPrice"
                            placeholder="Harga BTC (USD)"
                            class="flex-1 min-w-0 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                        >
                        <button @click="updateManualPrice"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 focus:outline-none transition ease-in-out duration-150">
                            Update Manual
                        </button>
                    </div>
                </div>

                <!-- Target Percentage -->
                <div>
                    <label for="target-percent" class="block text-sm font-medium text-gray-500">Target Keuntungan (%)</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input id="target-percent" type="number" step="1" min="1" max="1000" v-model="targetPercentageInput"
                            @change="updateTargetPercentage"
                            class="flex-1 min-w-0 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    </div>
                </div>

                <!-- Currency & Dark Mode Toggle -->
                <div class="flex flex-row space-x-4">
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-end">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="darkMode" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">Dark</span>
                        </label>
                    </div>
                </div>
            </div>
        </header>
       
        <!-- Portfolio Summary Cards -->
        <section class="mb-8">
            <div class="cardgrid-summary">
                <div v-for="(card, index) in portfolioCards" :key="index"
                    class="summarycard card bg-white p-5 rounded-xl border-l-4"
                    :class="[card.colorClass, card.borderColor]">
                    <p class="text-xs sm:text-sm font-medium text-gray-500 truncate">{{ card.title }}</p>
                    <p class="mt-1 text-base sm:text-2xl font-semibold transition-colors duration-300"
                        :class="card.colorClass">
                        {{ formatCurrency(card.value, currency) }}  <span v-if="card.convert">/ {{formatCurrency(card.convert,'IDR')}}</span>
                    </p>
                </div>
            </div>
        </section>

        <!-- Main Action and Lists -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-gray-100 transition-colors duration-300">
                    Daftar Transaksi Aktif
                </h2>
                <button @click="openAddModal"
                    class="px-3 sm:px-5 py-2 bg-blue-600 text-white text-sm sm:text-base font-medium rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150">
                    + Tambah Data
                </button>
            </div>

            <!-- Active Trades Table (with overflow-x-auto for responsiveness) -->
            <div class="overflow-x-auto bg-white p-2 sm:p-4 rounded-xl shadow-lg card">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tgl Beli</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Beli BTC </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Current BTC </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Modal Beli </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pajak</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Target (BTC)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Potential Untung </th>
                            <!-- <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Untung/Rugi (Sebelum Pajak)</th> -->
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Untung/Rugi Setelah Pajak</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Selisih (%)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <tr v-if="activeList.length === 0">
                            <td colspan="11" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Belum ada transaksi aktif. Silakan tambahkan data.</td>
                        </tr>
                        <tr v-for="trade in activeList" :key="trade.id" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ trade.tanggal_beli }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ formatCurrency(trade.harga_beli_bitcoin_usd, 'USD') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs font-bold" :class="getPLColor(trade.pl_percentage)">{{ formatCurrency(currentPriceUSD, 'USD') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ formatCurrency(trade.uang_beli_idr, 'IDR') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ formatCurrency(trade.pajak, 'IDR') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-blue-900  dark:text-gray-200" style="font-weight: bold;" @click="copyData(trade.target_harga_usd)">{{ trade.target_harga_usd.toFixed(0) }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">
                                {{formatCurrency(trade.potential_target - trade.pajak, 'USD')}} /   {{formatCurrency(( (trade.potential_target - trade.uang_beli_idr) - trade.pajak) * 16000, 'USD')}}
                            </td>
                            <!-- <td class="px-3 py-4 whitespace-nowrap text-xs font-bold" :class="getPLColor(trade.pl_percentage)">
                                {{ formatCurrency(trade.pl_nominal_idr, 'IDR') }}
                            </td> -->
                            <td class="px-3 py-4 whitespace-nowrap text-xs font-bold" :class="getPLColor(trade.pl_after_tax)">
                                {{ formatCurrency(trade.pl_after_tax, 'IDR') }} / {{formatCurrency(trade.pl_after_tax * 16000, 'IDR')}}
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs" :class="getPLColor(trade.pl_percentage)">
                                <span class="font-bold">{{ trade.pl_percentage.toFixed(2) }}%</span>
                                <span v-if="trade.is_near_target" class="ml-1 text-yellow-500 font-bold" title="Mendekati 90% target">‚ö†Ô∏è</span>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs font-medium space-x-1">
                                <button @click="moveToHistory(trade.id)"
                                    class="text-xs px-2 py-1 font-medium rounded-full bg-blue-500 text-white hover:bg-blue-600 transition duration-150"
                                    title="Pindahkan ke Riwayat (Tercapai)">
                                    Jual
                                </button>
                                <button @click="deleteTrade(trade.id)"
                                    class="text-xs px-2 py-1 font-medium rounded-full text-red-600 hover:text-red-900 transition duration-150"
                                    title="Hapus Transaksi">
                                    Hapus
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Chart Section -->
        <section class="mb-8 p-4 bg-white rounded-xl shadow-lg card">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-4 transition-colors duration-300">
                Grafik Profit/Loss Harian (History)
            </h2>
            <div class="flex space-x-4 mb-4">
                <div>
                    <label for="filter-year" class="block text-sm font-medium text-gray-500">Tahun</label>
                    <select id="filter-year" v-model="filter.year" @change="filterHistory"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <option value="">Semua</option>
                        <option v-for="year in availableYears" :key="year" :value="year">{{ year }}</option>
                    </select>
                </div>
                <div>
                    <label for="filter-month" class="block text-sm font-medium text-gray-500">Bulan</label>
                    <select id="filter-month" v-model="filter.month" @change="filterHistory"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <option value="">Semua</option>
                        <option v-for="(name, index) in monthNames" :key="index" :value="index + 1">{{ name }}</option>
                    </select>
                </div>
            </div>
            <div id="daily-chart"></div>
        </section>

        <!-- History Trades Table -->
        <section class="mb-8">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-4 transition-colors duration-300">
                Riwayat Transaksi (Tercapai)
            </h2>
            <div class="overflow-x-auto bg-white p-2 sm:p-4 rounded-xl shadow-lg card">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tgl Beli/Jual</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Harga Beli/Jual (USD)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Modal Beli </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pajak</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Target (USD)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Keuntungan </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Keuntungan Setelah Pajak</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">P/L %</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Catatan</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <tr v-if="historyList.length === 0">
                            <td colspan="10" class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Belum ada transaksi di riwayat.</td>
                        </tr>
                        <tr v-for="trade in filteredHistory" :key="trade.id"
                            class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                            :class="{ 'bg-green-50/50 dark:bg-green-900/20': trade.profit_percentage > 5 }">
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">
                                B: {{ trade.tanggal_beli }} <br> J: {{ trade.tanggal_jual }}
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">
                                B: {{ formatCurrency(trade.harga_beli_bitcoin_usd, 'USD') }}<br>
                                J: {{ formatCurrency(trade.harga_jual_bitcoin_usd, 'USD') }}
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ formatCurrency(trade.uang_beli_idr, 'IDR') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ formatCurrency(trade.pajak, 'IDR') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900 dark:text-gray-200">{{ formatCurrency(trade.target_harga_usd, 'USD') }}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs font-bold" :class="getPLColor(trade.profit_percentage)">
                                {{ formatCurrency(trade.profit_nominal_idr, 'IDR') }}
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs font-bold" :class="getPLColor(trade.profit_percentage)">
                                {{ formatCurrency(trade.profit_after_tax, 'IDR') }} / {{formatCurrency(trade.profit_after_tax * 16000,'IDR')}}
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-xs font-bold" :class="getPLColor(trade.profit_percentage)">
                                {{ trade.profit_percentage.toFixed(2) }}%
                            </td>
                            <td class="px-3 py-4 whitespace-normal text-xs text-gray-500 dark:text-gray-400 max-w-xs">
                                {{ trade.catatan_strategi.length > 50 ? trade.catatan_strategi.substring(0, 50) + '...' : trade.catatan_strategi }}
                            </td>
                            <td class="px-3 py-4 whitespace-normal text-xs text-gray-500 dark:text-gray-400 max-w-xs">
                                <button @click="deleteHistory(trade.id)"
                                    class="text-xs px-2 py-1 font-medium rounded-full text-red-600 hover:text-red-900 transition duration-150"
                                    title="Hapus Transaksi">
                                    Hapus
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="flex flex-wrap gap-4 justify-end mt-4 px-1">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">Total Profit:</span>
                        <span>
                            <span class="font-bold text-lg">
                                {{ formatCurrency(filteredHistory.reduce((sum, trade) => sum + (trade.profit_nominal_idr || 0), 0), 'IDR') }}
                            </span>
                        </span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">Total Profit Setelah Pajak:</span>
                        <span>
                            <span class="font-bold text-lg">
                                {{ formatCurrency(filteredHistory.reduce((sum, trade) => sum + (trade.profit_after_tax || 0), 0), 'IDR') }}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Add Data Modal -->
        <div v-if="showAddModal" @click.self="closeAddModal" class="fixed inset-0 z-50 overflow-y-auto modal-overlay flex items-center justify-center">
            <div @click.stop class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4 transition-all duration-300 scale-100 opacity-100">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Tambah Transaksi Pembelian Bitcoin</h3>
                <form @submit.prevent="addData">
                    <!-- Harga Beli Bitcoin (USD) -->
                    <div class="mb-4">
                        <label for="harga_beli" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Harga Beli Bitcoin (USD) - *Auto ambil dari harga live</label>
                        <input type="number" step="0.01" id="harga_beli" v-model.number="formData.harga_beli_bitcoin_usd" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    </div>

                    <!-- Uang Beli (IDR) -->
                    <div class="mb-4">
                        <label for="uang_beli" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Modal Beli </label>
                        <input type="number" step="0.01" id="uang_beli" @change="computePajak" v-model.number="formData.uang_beli_idr" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    </div>

                    <!-- Pajak -->
                    <div class="mb-4">
                        <label for="pajak" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pajak</label>
                        <input type="number" step="0.01" id="pajak" v-model.number="formData.pajak" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    </div>

                    <!-- Tanggal Beli -->
                    <div class="mb-4">
                        <label for="tanggal_beli" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tanggal Beli</label>
                        <input type="date" id="tanggal_beli" v-model="formData.tanggal_beli"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    </div>

                    <!-- Catatan Strategi -->
                    <div class="mb-6">
                        <label for="catatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Catatan Strategi (Opsional)</label>
                        <textarea id="catatan" v-model="formData.catatan_strategi" rows="3"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="closeAddModal"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-700">
                            Batal
                        </button>
                        <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">
                            Simpan Transaksi
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mb-8">
            <div class="mb-4 flex justify-end">
                <a href="https://www.tokocrypto.com/id/trade/BTC_USDT" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow transition duration-150 text-sm">
                    BTC USD
                    <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 7h-10m10 0l-6 6m0 0l6 6" />
                    </svg>
                </a>
            </div>
            <iframe 
                src="https://bitbo.io" 
                title="Bitbo Bitcoin Analytics"
                width="100%"
                height="600"
                frameborder="0"
                style="border-radius: 1rem; overflow: hidden; box-shadow: 0 2px 16px rgba(0,0,0,0.12); min-height:350px;"
                allowfullscreen
                sandbox="allow-same-origin allow-scripts allow-popups"
                referrerpolicy="no-referrer">
            </iframe>
        </div>

        <!-- Notification Box -->
        <div v-if="notification.show"
             class="fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300"
             :class="notification.isError ? 'bg-red-500' : 'bg-green-500'"
             style="z-index: 60;">
            {{ notification.message }}
        </div>

    </div>

    <script>
        // Firebase App config - Ganti dengan config Firebase Anda sendiri
        const firebaseConfig = {
            apiKey: "AIzaSyCw8qsPyiHYI8xzx86TzebcHMcpLXyVU8g",
            authDomain: "hasnur-b7714.firebaseapp.com",
            databaseURL: "https://hasnur-b7714-default-rtdb.firebaseio.com",
            projectId: "hasnur-b7714",
            storageBucket: "hasnur-b7714.firebasestorage.app",
            messagingSenderId: "976635488805",
            appId: "1:976635488805:web:b0a3861def4d0f7afc2dcc",
            measurementId: "G-HZ03ZJNMJW"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const docRef = db.collection('bitcoin').doc('main');

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            data() {
                return {
                    // Core Data
                    activeList: [],
                    historyList: [],
                    
                    // Price & Currency Settings
                    currentPriceUSD: 0,
                    currentPriceInput: 0,
                    targetPercentage: 10,
                    targetPercentageInput: 10,
                    currency: 'IDR',
                    lastFetchedTime: 'Belum pernah di-fetch',
                    fetchInterval: null,

                    // UI State
                    showAddModal: false,
                    formData: {
                        harga_beli_bitcoin_usd: null,
                        uang_beli_idr: null,
                        pajak: 0,
                        tanggal_beli: new Date().toISOString().slice(0, 10),
                        catatan_strategi: ''
                    },
                    notification: {
                        show: false,
                        message: '',
                        isError: false
                    },
                    darkMode: false,

                    filter: {
                        year: '',
                        month: ''
                    },
                    monthNames: ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"],
                    chart: null,

                    isInitialized: false,
                };
            },
            computed: {
                totalActiveModal() {
                    return this.activeList.reduce((sum, trade) => sum + trade.uang_beli_idr, 0);
                },
                totalActiveProfitLoss() {
                    // Sum all pl_nominal_idr which is profit(%) x modal
                    return this.activeList.reduce((sum, trade) => sum + trade.pl_nominal_idr - trade.pajak, 0);
                },
                totalProfitLossHistory() {
                    return this.historyList.reduce((sum, trade) => sum + trade.profit_nominal_idr - (trade.pajak ?? 0), 0);
                },
                portfolioCards() {
                    const totalPL = this.totalActiveProfitLoss;
                    return [
                        { title: 'Total Modal Aktif ', value: this.totalActiveModal, colorClass: 'text-blue-600', borderColor: 'border-blue-600' },
                        { title: 'Total P/L Aktif ', value: totalPL, convert:totalPL * 16000, colorClass: totalPL >= 0 ? 'text-green-600' : 'text-red-600', borderColor: totalPL >= 0 ? 'border-green-600' : 'border-red-600' },
                        { title: 'Total P/L Riwayat', value: this.totalProfitLossHistory, convert:this.totalProfitLossHistory * 16000, colorClass: this.totalProfitLossHistory >= 0 ? 'text-green-600' : 'text-red-600', borderColor: this.totalProfitLossHistory >= 0 ? 'border-green-600' : 'border-red-600' },
                    ];
                },
                filteredHistory() {
                    return this.historyList.filter(trade => {
                        const tradeDate = new Date(trade.tanggal_jual);
                        const tradeYear = tradeDate.getFullYear().toString();
                        const tradeMonth = (tradeDate.getMonth() + 1).toString();
                        const yearMatch = !this.filter.year || tradeYear === this.filter.year;
                        const monthMatch = !this.filter.month || tradeMonth === this.filter.month;
                        return yearMatch && monthMatch;
                    }).sort((a, b) => new Date(b.tanggal_jual) - new Date(a.tanggal_jual));
                },
                availableYears() {
                    const years = new Set(this.historyList.map(trade => new Date(trade.tanggal_jual).getFullYear().toString()));
                    return Array.from(years).sort().reverse();
                },
                chartData() {
                    const dailyProfits = {};
                    this.filteredHistory.forEach(trade => {
                        const dateKey = trade.tanggal_jual;
                        const profitNominal = trade.profit_nominal_idr;
                        if (!dailyProfits[dateKey]) dailyProfits[dateKey] = 0;
                        dailyProfits[dateKey] += profitNominal;
                    });
                    const sortedDates = Object.keys(dailyProfits).sort();
                    return {
                        categories: sortedDates,
                        series: [{
                            name: `Profit/Loss Harian `,
                            data: sortedDates.map(date => dailyProfits[date])
                        }]
                    };
                }
            },
            methods: {
                computePajak(){
                    this.formData.pajak=this.formData.uang_beli_idr * 0.0021
                },
                copyData(data){
                    if (data !== undefined && data !== null) {
                        const input = document.createElement('textarea');
                        input.value = (typeof data === "number" ? data.toFixed(0) : data);
                        document.body.appendChild(input);
                        input.select();
                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                this.showNotification("Tercopy ke clipboard! (Ctrl + V untuk paste)", false);
                            } else {
                                this.showNotification("Copy ke clipboard gagal.", true);
                            }
                        } catch (err) {
                            this.showNotification("Copy ke clipboard gagal.", true);
                        }
                        document.body.removeChild(input);
                    } else {
                        this.showNotification("Data kosong, tidak bisa copy.", true);
                    }
                },
                showNotification(message, isError = false) {
                    this.notification.message = message;
                    this.notification.isError = isError;
                    this.notification.show = true;
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },
                formatCurrency(value, curr) {
                    // Hanya tampilkan angka dengan format 10.000.000 (tanpa simbol mata uang)
                    return new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
                },
                formatNumber(value) {
                    return new Intl.NumberFormat('id-ID').format(value);
                },
                getPLColor(percentage) {
                    if (percentage >= 0) {
                        return 'text-green-600 dark:text-green-400';
                    }
                    return 'text-red-600 dark:text-red-400';
                },

                // BTC amount NOT SHOWN ANYMORE - do not use
                // Only used for adding record, to be backward compatible, but not shown nor used for P/L

                async saveToFirebase() {
                    if (!this.isInitialized) return;
                    try {
                        await docRef.set({
                            activeList: this.activeList,
                            historyList: this.historyList,
                            currency: this.currency,
                            targetPercentage: this.targetPercentage,
                            darkMode: this.darkMode
                        });
                    } catch (e) {
                        console.error("Gagal menyimpan ke Firebase", e);
                        this.showNotification("Gagal menyimpan data ke Firebase.", true);
                    }
                },

                async loadFromFirebase() {
                    try {
                        const doc = await docRef.get();
                        if (doc.exists) {
                            const data = doc.data();
                            this.activeList = Array.isArray(data.activeList) ? data.activeList : [];
                            this.historyList = Array.isArray(data.historyList) ? data.historyList : [];
                            this.currency = data.currency || 'IDR';
                            if (typeof data.targetPercentage === "number") {
                                this.targetPercentage = data.targetPercentage;
                                this.targetPercentageInput = data.targetPercentage;
                            }
                            if (typeof data.darkMode === "boolean") {
                                this.darkMode = data.darkMode;
                                document.body.classList.toggle('dark', this.darkMode);
                            }
                        }
                        this.isInitialized = true;
                    } catch (e) {
                        console.error("Gagal memuat dari Firebase", e);
                        this.showNotification("Gagal memuat data dari Firebase.", true);
                        this.isInitialized = true;
                    }
                },

                async fetchBitcoinPrice() {
                    try {
                        const url = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=USD';
                        const response = await fetch(url);
                        const data = await response.json();
                        if (data.bitcoin && data.bitcoin.usd) {
                            this.currentPriceUSD = data.bitcoin.usd;
                            this.currentPriceInput = data.bitcoin.usd;
                            this.lastFetchedTime = new Date().toLocaleTimeString('id-ID');
                            this.showNotification(`Harga BTC berhasil di-update: $${this.currentPriceUSD.toFixed(2)}`, false);
                            this.updateActiveTrades();
                        } else {
                            throw new Error("Data harga tidak valid dari API.");
                        }
                    } catch (e) {
                        console.error("Gagal fetch harga Bitcoin:", e);
                        this.showNotification("Gagal fetch harga Bitcoin dari CoinGecko.", true);
                        if (this.currentPriceUSD === 0) {
                            this.currentPriceUSD = 65000;
                            this.currentPriceInput = 65000;
                            this.lastFetchedTime = `FALLBACK (${new Date().toLocaleTimeString('id-ID')})`;
                        }
                        this.updateActiveTrades();
                    }
                },

                updateManualPrice() {
                    const newPrice = parseFloat(this.currentPriceInput);
                    if (isNaN(newPrice) || newPrice <= 0) {
                        this.showNotification("Harga manual harus berupa angka positif.", true);
                        return;
                    }
                    this.currentPriceUSD = newPrice;
                    this.lastFetchedTime = `MANUAL (${new Date().toLocaleTimeString('id-ID')})`;
                    this.updateActiveTrades();
                    this.showNotification(`Harga BTC diperbarui manual: $${this.currentPriceUSD.toFixed(2)}`, false);
                },

                async updateTargetPercentage() {
                    const newTarget = parseFloat(this.targetPercentageInput);
                    if (isNaN(newTarget) || newTarget < 0) {
                        this.showNotification("Target persentase harus angka non-negatif.", true);
                        this.targetPercentageInput = this.targetPercentage;
                        return;
                    }
                    this.targetPercentage = newTarget;
                    this.updateActiveTrades();
                    await this.saveToFirebase();
                    this.showNotification(`Target keuntungan diperbarui menjadi ${newTarget}%`, false);
                },

                async updateActiveTrades() {
                    // Selisih = (Current-Buy)/Buy
                    this.activeList = this.activeList.map(trade => {
                        const buyPrice = trade.harga_beli_bitcoin_usd;
                        const currentPrice = this.currentPriceUSD;
                        const pajak = Number(trade.pajak) || 0;
                        // % selisih harga
                        const priceDiffPerc = ((currentPrice - buyPrice) / buyPrice) * 100;
                        trade.pl_percentage = priceDiffPerc;
                        // P/L Nominal
                        trade.pl_nominal_idr = trade.uang_beli_idr * (priceDiffPerc / 100);
                        trade.target_harga_usd = buyPrice * (1 + this.targetPercentage / 100);
                        trade.potential_target = trade.uang_beli_idr * (1 + this.targetPercentage / 100);
                        const targetDifference = trade.target_harga_usd - trade.harga_beli_bitcoin_usd;
                        const currentDifference = currentPrice - trade.harga_beli_bitcoin_usd;
                        trade.is_near_target = currentDifference >= (targetDifference * 0.9);

                        // P/L setelah pajak (profit nominal - pajak)
                        trade.pl_after_tax = trade.pl_nominal_idr - pajak;
                        return trade;
                    });
                    await this.saveToFirebase();
                },

                openAddModal() {
                    this.formData = {
                        harga_beli_bitcoin_usd: this.currentPriceUSD,
                        uang_beli_idr: null,
                        pajak: 0,
                        tanggal_beli: new Date().toISOString().slice(0, 10),
                        catatan_strategi: ''
                    };
                    this.showAddModal = true;
                },
                closeAddModal() {
                    this.showAddModal = false;
                },

                async addData() {
                    const { harga_beli_bitcoin_usd, uang_beli_idr, pajak, tanggal_beli, catatan_strategi } = this.formData;

                    if (!harga_beli_bitcoin_usd || !uang_beli_idr || harga_beli_bitcoin_usd <= 0 || uang_beli_idr <= 0) {
                        this.showNotification("Harga BTC dan Modal Beli harus diisi dengan angka positif.", true);
                        return;
                    }

                    const buyPrice = harga_beli_bitcoin_usd;
                    const currentPrice = this.currentPriceUSD;
                    const priceDiffPerc = ((currentPrice - buyPrice) / buyPrice) * 100;
                    const target_harga_usd = buyPrice * (1 + this.targetPercentage / 100);

                    const pl_nominal_idr = uang_beli_idr * (priceDiffPerc / 100);
                    const safePajak = Number(pajak) || 0;

                    const newTrade = {
                        id: Date.now(),
                        tanggal_beli: tanggal_beli,
                        harga_beli_bitcoin_usd: buyPrice,
                        uang_beli_idr: uang_beli_idr,
                        pajak: safePajak,
                        catatan_strategi: catatan_strategi,
                        target_harga_usd: target_harga_usd,
                        pl_percentage: priceDiffPerc,
                        pl_nominal_idr: pl_nominal_idr,
                        pl_after_tax: pl_nominal_idr - safePajak,
                        is_near_target: false,
                    };

                    this.activeList.unshift(newTrade);
                    await this.updateActiveTrades();
                    await this.saveToFirebase();
                    this.closeAddModal();
                    this.showNotification("Transaksi pembelian baru berhasil ditambahkan.", false);
                },

                async deleteTrade(id) {
                    const deleteConfirmed = window.confirm("Apakah Anda yakin ingin menghapus transaksi ini?");
                    if (deleteConfirmed) {
                        this.activeList = this.activeList.filter(trade => trade.id !== id);
                        await this.saveToFirebase();
                        this.showNotification("Transaksi berhasil dihapus.", false);
                    }
                },
                async deleteHistory(id) {
                    const deleteConfirmed = window.confirm("Apakah Anda yakin ingin menghapus transaksi ini?");
                    if (deleteConfirmed) {
                        this.historyList = this.historyList.filter(trade => trade.id !== id);
                        await this.saveToFirebase();
                        this.showNotification("Transaksi riwayat berhasil dihapus.", false);
                        this.renderChart();
                    }
                },

                async moveToHistory(id) {
                    const tradeIndex = this.activeList.findIndex(trade => trade.id === id);
                    if (tradeIndex === -1) return;

                    const trade = this.activeList[tradeIndex];

                    const hargaJualUSD = this.currentPriceUSD;
                    const pajak = Number(trade.pajak) || 0;
                    const priceDiff = ((hargaJualUSD - trade.harga_beli_bitcoin_usd) / trade.harga_beli_bitcoin_usd) * 100;
                    const profitNominalIDR = trade.uang_beli_idr * (priceDiff / 100);

                    const profitAfterTax = profitNominalIDR - pajak;

                    const historyTrade = {
                        ...trade,
                        tanggal_jual: new Date().toISOString().slice(0, 10),
                        harga_jual_bitcoin_usd: hargaJualUSD,
                        profit_nominal_idr: profitNominalIDR,
                        profit_after_tax: profitAfterTax,
                        profit_percentage: priceDiff,
                    };

                    this.historyList.unshift(historyTrade);
                    this.activeList.splice(tradeIndex, 1);

                    await this.saveToFirebase();
                    this.renderChart();
                    this.showNotification(`Transaksi berhasil dipindahkan ke riwayat. Keuntungan: ${this.formatCurrency(profitNominalIDR, 'IDR')}, setelah pajak: ${this.formatCurrency(profitAfterTax, 'IDR')}`, false);
                },

                filterHistory() {
                    this.renderChart();
                },

                renderChart() {
                    const chartData = this.chartData;
                    const chartElement = document.getElementById('daily-chart');

                    if (chartData.categories.length === 0) {
                        if (this.chart) this.chart.destroy();
                        chartElement.innerHTML = '<p class="text-center py-10 text-gray-500 dark:text-gray-400">Tidak ada data riwayat untuk ditampilkan di grafik (P/L dihitung dalam IDR).</p>';
                        return;
                    }

                    const chartOptions = {
                        series: chartData.series,
                        chart: {
                            type: 'bar',
                            height: 350,
                            toolbar: { show: true },
                            animations: { enabled: true }
                        },
                        plotOptions: {
                            bar: {
                                horizontal: false,
                                columnWidth: '55%',
                                endingShape: 'rounded'
                            },
                        },
                        dataLabels: { enabled: false },
                        stroke: { show: true, width: 2, colors: ['transparent'] },
                        xaxis: {
                            categories: chartData.categories,
                            title: { text: 'Tanggal Jual' }
                        },
                        yaxis: {
                            title: { text: `Total P/L ` },
                            labels: {
                                formatter: (val) => this.formatCurrency(val, 'IDR').replace(/^Rp/, '')
                            }
                        },
                        fill: { opacity: 1 },
                        tooltip: {
                            y: {
                                formatter: (val) => this.formatCurrency(val, 'IDR')
                            }
                        },
                        colors: ['#3b82f6'],
                    };

                    if (this.chart) {
                        this.chart.updateOptions(chartOptions);
                    } else {
                        chartElement.innerHTML = '';
                        this.chart = new ApexCharts(chartElement, chartOptions);
                        this.chart.render();
                    }
                },

                async toggleDarkMode() {
                    document.body.classList.toggle('dark', this.darkMode);
                    await this.saveToFirebase();
                }
            },

            mounted() {
                this.loadFromFirebase().then(() => {
                    this.updateActiveTrades();
                    this.renderChart();
                    watch(() => this.darkMode, this.toggleDarkMode);
                    this.fetchBitcoinPrice();
                    this.fetchInterval = setInterval(this.fetchBitcoinPrice, 60000);
                    watch(() => this.chartData, () => this.renderChart(), { deep: true });
                    this.$nextTick(() => {
                        this.renderChart();
                    });
                    this.unmounted = () => {
                        clearInterval(this.fetchInterval);
                    };
                });
            }
        }).mount('#app');
    </script>
</body>
</html>