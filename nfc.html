<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem NFC Jembatan Timbang</title>
    <!-- Tailwind CSS CDN for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Custom Tailwind Configuration */
        :root {
            --primary-color: #3B82F6; /* Blue-500 */
            --secondary-color: #10B981; /* Emerald-500 */
            --danger-color: #EF4444; /* Red-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F9FC; /* Lightest background */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border-radius: 1.5rem;
            transition: all 0.3s ease;
        }

        /* Menu Card Specific Styling */
        .menu-card {
            height: 200px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
        }
        
        /* Button Styles */
        .btn-action {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }

        /* Status Styling */
        .status-box {
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
        }
        .status-success {
            background-color: #D1FAE5; /* Emerald-100 */
            color: #065F46; /* Emerald-800 */
        }
        .status-fail {
            background-color: #FEE2E2; /* Red-100 */
            color: #991B1B; /* Red-800 */
        }
        .status-info {
            background-color: #DBEAFE; /* Blue-100 */
            color: #1E40AF; /* Blue-800 */
        }

        /* Responsive Layout for Input Form */
        @media (min-width: 640px) {
            .input-group {
                display: flex;
                gap: 1rem;
            }
            .input-group > div {
                flex: 1;
            }
        }

        /* Traffic Light Simulation Styles (BIGGER for better mobile view!) */
        .traffic-light-outer {
            width: 110px;
            background: #222;
            border-radius: 50px;
            padding: 28px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin: 0 auto 24px auto;
            box-shadow: 0 4px 12px rgba(50,50,50,0.13);
            border: 5px solid #333;
        }
        .traffic-light-bulb {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: #333;
            margin: 7px 0;
            box-shadow: 0 2px 14px rgba(0,0,0,0.16);
            border: 5px solid #555;
            transition: background 0.25s, box-shadow 0.25s;
        }
        .light-red {
            background: #a52822;
            box-shadow: 0 0 28px 7px #ff5757;
        }
        .light-yellow {
            background: #dfba0f;
            box-shadow: 0 0 28px 7px #ffee68;
        }
        .light-green {
            background: #32b225;
            box-shadow: 0 0 28px 7px #7effae;
        }
        .off {
            opacity: 0.3;
            filter: grayscale(80%);
        }
        /* For traffic light pedestal effect, make also bigger */
        .traffic-light-stand {
            width: 30px;
            height: 58px;
            background: #444;
            margin: 0 auto;
            border-radius: 0 0 20px 20px;
        }

        /* --- Smooth blinking effect for traffic lights --- */
        @keyframes smooth-blink {
            0% { opacity:1; }
            60% { opacity:0.25; }
            100% { opacity:1; }
        }
        .blinking {
            animation: smooth-blink 1.1s infinite cubic-bezier(.4,0,.6,1);
        }

        /* Responsive tweak: reduce size a bit for landscape/tablet */
        @media (min-width: 600px) {
            .traffic-light-outer {
                width: 70px;
                padding: 18px 0;
                border-radius: 34px;
                gap: 19px;
                border-width: 3px;
            }
            .traffic-light-bulb {
                width: 38px;
                height: 38px;
                border-width: 3px;
                box-shadow: 0 1px 8px rgba(0,0,0,0.13);
                margin: 5px 0;
            }
            .traffic-light-stand {
                width: 18px;
                height: 32px;
                border-radius: 0 0 12px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="p-4 w-full max-w-xl">
        <div class="card p-6 md:p-8">
            <div v-if="currentView === 'menu'">
                <h2 class="text-xl font-bold text-gray-700 mb-6 border-b pb-3" @click="test">Menu Utama</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Gate Bridge Reader Card -->
                    <div @click="changeView('reader')" class="menu-card bg-blue-500 text-white flex flex-col items-center justify-center p-6 rounded-xl shadow-lg">
                        <i class="fas fa-route text-4xl mb-3"></i>
                        <span class="text-lg font-bold">Buka Gerbang Timbang</span>
                        <span class="text-sm opacity-80 mt-1">Pembacaan Tag Akses</span>
                    </div>

                    <!-- Driver & Unit Registration Card -->
                    <div @click="changeView('writer')" class="menu-card bg-green-500 text-white flex flex-col items-center justify-center p-6 rounded-xl shadow-lg">
                        <i class="fas fa-address-card text-4xl mb-3"></i>
                        <span class="text-lg font-bold">Daftar Pengemudi & Unit</span>
                        <span class="text-sm opacity-80 mt-1">Penulisan Data ke Tag</span>
                    </div>
                </div>

                <!-- Menu Timbang Masuk/Keluar Start -->
                <div class="mt-10 bg-gray-50 rounded-2xl p-6 border">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fas fa-weight text-yellow-500"></i> Jembatan Timbang Simulasi
                    </h3>
                    <div class="flex items-center gap-4 mb-3">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" v-model="simulasiInLebihBesar" class="form-checkbox text-green-500">
                            In selalu lebih dari Out
                        </label>
                        <span class="text-gray-400 text-xs">(Centang: berat masuk > berat keluar)</span>
                    </div>
                    <div class="flex gap-4 mb-4">
                        <button @click="timbangMasuk" class="btn-action bg-yellow-400 text-white shadow hover:bg-yellow-500 flex-1">
                            <i class="fas fa-arrow-circle-down mr-2"></i> Timbang Masuk
                        </button>
                        <button @click="timbangKeluar" class="btn-action bg-orange-500 text-white shadow hover:bg-orange-600 flex-1">
                            <i class="fas fa-arrow-circle-up mr-2"></i> Timbang Keluar
                        </button>
                    </div>
                    <div v-if="timbangStatus" :class="{'status-success': timbangSuccess, 'status-fail': !timbangSuccess}" class="status-box mt-2 text-center">
                        <i v-if="timbangSuccess" class="fas fa-check-circle mr-2"></i>
                        <i v-else class="fas fa-exclamation-triangle mr-2"></i>
                        {{ timbangStatus }}
                    </div>
                    <div class="mt-2 text-xs text-gray-400">
                      <p>
                        Contoh simulasi dump truck berisi janjang TBS. Berat akan diisi random sesuai logika checkbox.
                      </p>
                    </div>
                    <div class="flex gap-2 mt-2 text-sm">
                        <div class="p-2 rounded bg-gray-100 flex-1 text-center">
                            <div class="font-semibold text-gray-600">Berat Masuk</div>
                            <div class="font-bold text-xl text-yellow-700" v-if="beratIn">{{ beratIn }} kg</div>
                            <div v-else class="text-gray-400">-</div>
                        </div>
                        <div class="p-2 rounded bg-gray-100 flex-1 text-center">
                            <div class="font-semibold text-gray-600">Berat Keluar</div>
                            <div class="font-bold text-xl text-orange-700" v-if="beratOut">{{ beratOut }} kg</div>
                            <div v-else class="text-gray-400">-</div>
                        </div>
                    </div>
                </div>
                <!-- Menu Timbang Masuk/Keluar End -->

            </div>

            <!-- VIEW: Gate Reader (Membuka Gerbang) -->
            <div v-else-if="currentView === 'reader'">
                <h2 class="text-xl font-bold text-gray-700 mb-6 border-b pb-3 flex items-center gap-2">
                    <i class="fas fa-route text-blue-500"></i> Pembaca Gerbang Timbang
                </h2>
                
                <div v-if="!ndefReaderSupported" class="status-box status-fail mb-6">
                    <i class="fas fa-times-circle mr-2"></i> NFC tidak didukung pada perangkat/browser ini.
                </div>
                
                <!-- <div class="text-center mb-6">
                    <button @click="toggleReader" :disabled="nfcBusy" :class="{'bg-gray-400': nfcBusy, 'bg-blue-600 hover:bg-blue-700': !nfcBusy}" class="btn-action text-white shadow-lg">
                        <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': readerActive}"></i>
                        {{ readerActive ? 'Batalkan Pembacaan' : 'Mulai Scan Tag Akses' }}
                    </button>
                </div> -->

                <!-- Selalu tampilkan traffic light di tampilan "reader" -->
                <div class="flex flex-col items-center justify-center my-8">
                    <div class="traffic-light-outer">
                        <span :class="['traffic-light-bulb', 'light-red', trafficLightState==='red'?'blinking':'', trafficLightState!=='red'?'off':'']"></span>
                        <span :class="['traffic-light-bulb', 'light-yellow', trafficLightState==='yellow'?'blinking':'', trafficLightState!=='yellow'?'off':'']"></span>
                        <span :class="['traffic-light-bulb', 'light-green', trafficLightState==='green'?'blinking':'', trafficLightState!=='green'?'off':'']"></span>
                    </div>
                    <div class="traffic-light-stand"></div>
                    <div v-if="readerActive && !readMessage" class="font-semibold text-gray-500 mt-3 text-center" style="letter-spacing:0.5px;">
                        <span>Menunggu scan NFC...<br>{{ nfcInstruction }}</span>
                    </div>
                    <div v-else-if="readStatus === 'success'" class="font-semibold text-green-700 mt-3 text-center" style="letter-spacing:0.5px;">
                        <span style="font-size:1.1em;">Akses NFC Berhasil</span>
                    </div>
                    <div v-else-if="readStatus === 'fail'" class="font-semibold text-red-700 mt-3 text-center" style="letter-spacing:0.5px;">
                        <span style="font-size:1.1em;">Akses NFC Gagal</span>
                    </div>
                </div>
                <!-- END: Traffic Light Simulation For Scan Status -->

                <!-- Status Feedback -->
                <div v-if="readMessage" :class="{'status-success': readStatus === 'success', 'status-fail': readStatus === 'fail', 'status-info': readStatus === 'info'}" class="status-box mb-6">
                    <i :class="readIcon" class="mr-2"></i> {{ readMessage }}
                </div>

                <!-- Parsed Data Display -->
                <div v-if="parsedReadData" class="mt-6 border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Detail Akses Tag:</h3>
                    <div class="space-y-2">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-500">ID Pengemudi:</span> 
                            <span class="font-bold text-gray-800 float-right">{{ parsedReadData.driverId || 'N/A' }}</span>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-500">Nomor Unit:</span> 
                            <span class="font-bold text-gray-800 float-right">{{ parsedReadData.unit || 'N/A' }}</span>
                        </div>
                    </div>
                    
                    <!-- Gate Action Status -->
                    <div v-if="readStatus === 'success'" class="text-center mt-6 p-4 rounded-xl bg-green-100 border border-green-400">
                        <i class="fas fa-check-circle text-green-600 text-3xl"></i>
                        <p class="text-green-800 font-bold text-xl mt-2">GERBANG DIBUKA!</p>
                        <p class="text-sm text-green-700">Akses disetujui untuk unit ini.</p>
                    </div>
                </div>

                <button @click="changeView('menu')" class="mt-8 btn-action bg-gray-200 text-gray-700 hover:bg-gray-300 w-full">
                    <i class="fas fa-arrow-left mr-2"></i> Kembali ke Menu
                </button>
            </div>

            <!-- VIEW: Driver/Unit Registration (Pendaftaran) -->
            <div v-else-if="currentView === 'writer'">
                <h2 class="text-xl font-bold text-gray-700 mb-6 border-b pb-3 flex items-center gap-2">
                    <i class="fas fa-address-card text-green-500"></i> Pendaftaran Pengemudi
                </h2>
                
                <div v-if="!ndefReaderSupported" class="status-box status-fail mb-6">
                    <i class="fas fa-times-circle mr-2"></i> NFC tidak didukung pada perangkat/browser ini.
                </div>

                <div class="space-y-4 mb-6">
                    <!-- Driver ID Input -->
                    <div>
                        <label for="driverIdInput" class="block text-sm font-medium text-gray-700 mb-1">ID Pengemudi (Wajib)</label>
                        <input type="text" id="driverIdInput" v-model="driverIdInput" placeholder="Masukkan ID atau Nama Pengemudi" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <!-- Unit Number Input -->
                    <div>
                        <label for="unitNumberInput" class="block text-sm font-medium text-gray-700 mb-1">Nomor Unit (Wajib)</label>
                        <input type="text" id="unitNumberInput" v-model="unitNumberInput" placeholder="Masukkan Nomor Unit/Kendaraan" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <div class="text-center mb-6">
                    <button @click="writeToNFC" :disabled="nfcBusy || !formValid" :class="{'bg-gray-400': nfcBusy || !formValid, 'bg-green-600 hover:bg-green-700': !nfcBusy && formValid}" class="btn-action text-white shadow-lg">
                        <i class="fas fa-pen-square mr-2"></i>
                        {{ nfcBusy ? 'Menunggu Tag...' : 'Tulis Data ke Tag NFC' }}
                    </button>
                </div>
                
                <!-- Status Feedback -->
                <div v-if="writeMessage" :class="{'status-success': writeStatus === 'success', 'status-fail': writeStatus === 'fail', 'status-info': writeStatus === 'info'}" class="status-box mb-6">
                    <i :class="writeIcon" class="mr-2"></i> {{ writeMessage }}
                </div>

                <button @click="changeView('menu')" class="mt-4 btn-action bg-gray-200 text-gray-700 hover:bg-gray-300 w-full">
                    <i class="fas fa-arrow-left mr-2"></i> Kembali ke Menu
                </button>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    // Global State
                    currentView: 'menu', // 'menu', 'reader', 'writer'
                    nfcBusy: false,
                    ndefReaderSupported: ('NDEFReader' in window),

                    // Reader State
                    readerActive: false,
                    ndefReader: null,
                    nfcInstruction: 'Dekatkan tag NFC akses ke perangkat...',

                    readData: null,
                    parsedReadData: null, // Parsed JSON data
                    readMessage: '',
                    readStatus: '', // 'success', 'fail', 'info'
                    // Added for the 10s gate close timer
                    afterSuccessTimer: null,

                    // ---- For traffic light state machine ----
                    trafficLightState: 'red',           // 'red', 'yellow', 'green'
                    trafficLightToYellowTimer: null,
                    trafficLightToGreenTimer: null,

                    // Writer State
                    driverIdInput: '',
                    unitNumberInput: '',
                    writeStatus: '',
                    writeMessage: '',

                    // Timbang Masuk/Keluar Simulasi
                    simulasiInLebihBesar: true,
                    beratIn: null,
                    beratOut: null,
                    timbangStatus: '',
                    timbangSuccess: false,
                }
            },
            computed: {
                formValid() {
                    return this.driverIdInput.trim().length > 0 && this.unitNumberInput.trim().length > 0
                },
                readIcon() {
                    if (this.readStatus === 'success') return 'fas fa-check-circle'
                    if (this.readStatus === 'fail') return 'fas fa-exclamation-triangle'
                    return 'fas fa-info-circle'
                },
                writeIcon() {
                    if (this.writeStatus === 'success') return 'fas fa-check-circle'
                    if (this.writeStatus === 'fail') return 'fas fa-exclamation-triangle'
                    return 'fas fa-info-circle'
                }
            },
            watch: {
                readerActive(val) {
                    // Reset on open reader
                    if (val) {
                        this.setTrafficLightState('red');
                    } else if (!this.readMessage) {
                        this.setTrafficLightState('red');
                    }
                },
                readStatus(val) {
                    // Only trigger transition on successful read/failed
                    if (val === 'success') {
                        this.setTrafficLightState('yellow');
                        if (this.trafficLightToGreenTimer) clearTimeout(this.trafficLightToGreenTimer);
                        this.trafficLightToGreenTimer = setTimeout(() => {
                            this.setTrafficLightState('green');
                        }, 2000);
                    } else if (val === 'fail') {
                        this.setTrafficLightState('red');
                        if (this.trafficLightToGreenTimer) clearTimeout(this.trafficLightToGreenTimer);
                    }
                },
                // Reset when changing view
                currentView(val) {
                    if (val !== 'reader') {
                        this.setTrafficLightState('red');
                        if (this.trafficLightToGreenTimer) clearTimeout(this.trafficLightToGreenTimer);
                    }
                }
            },
            methods: {
                setTrafficLightState(state) {
                    this.trafficLightState = state;
                },
                test(){
                    fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/gate.json', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(1)
                    })
                    .then(response => {}).catch(error => {});
                    fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/plate.json', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify('KH8023JM')
                    })
                    .then(response => {})
                    .catch(error => {});
                },
                // --- Timbang Simulasi ---
                timbangMasuk() {
                    // Simulasi, TBS, dump truck: rata-rata kosong 6500-7500kg, penuh 13500-18500kg
                    // Kalau checkbox true: in > out (masuk isi, keluar kosong); else: in < out (masuk kosong, keluar isi)
                    let inValue, outValue;
                    if (this.simulasiInLebihBesar) {
                        // Masuk penuh, keluar kosong
                        inValue = this._randInt(13500, 18500); // konten TBS + dump truck
                        outValue = this._randInt(6500, 7500);  // dump truck kosong
                    } else {
                        // Masuk kosong, keluar penuh
                        inValue = this._randInt(6500, 7500);
                        outValue = this._randInt(13500, 18500);
                    }
                    this.beratIn = inValue;
                    this.beratOut = null; // reset out
                    this.timbangStatus = '';
                    this.timbangSuccess = false;

                    // Simulasi kirim data
                    fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/weigbridge.json', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(inValue)
                    })
                    .then(response => {
                        this.timbangStatus = 'Berhasil mengirim data berat masuk: ' + inValue + ' kg';
                        this.timbangSuccess = true;
                    })
                    .catch(error => {
                        this.timbangStatus = 'Gagal mengirim data berat masuk.';
                        this.timbangSuccess = false;
                    });
                },
                timbangKeluar() {
                    // Simulasi timbang keluar (out)
                    let inValue = this.beratIn;
                    let outValue = null;

                    if (this.simulasiInLebihBesar) {
                        // Timbang keluar (kosong) harus lebih kecil dari timbang masuk (isi)
                        outValue = this._randInt(6500, 7500);
                        if (inValue != null && outValue > inValue) outValue = inValue - this._randInt(500,1200); // force < in
                        if (outValue < 0) outValue = 0;
                    } else {
                        // Timbang keluar (isi) harus lebih besar dari timbang masuk (kosong)
                        outValue = this._randInt(13500, 18500);
                        if (inValue != null && outValue < inValue) outValue = inValue + this._randInt(500,1200); // force > in
                    }

                    this.beratOut = outValue;
                    this.timbangStatus = '';
                    this.timbangSuccess = false;
                    fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/weigbridge.json', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(outValue)
                    })
                    .then(response => {
                        this.timbangStatus = 'Berhasil mengirim data berat keluar: ' + outValue + ' kg';
                        this.timbangSuccess = true;
                    })
                    .catch(error => {
                        this.timbangStatus = 'Gagal mengirim data berat keluar.';
                        this.timbangSuccess = false;
                    });
                },
                _randInt(min, max) {
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                },

                changeView(view) {
                    this.resetStates()
                    this.currentView = view
                    // Auto start scan if on reader view
                    if (view === 'reader' && this.ndefReaderSupported) {
                        this.startContinuousScan()
                    }
                },
                resetStates() {
                    this.stopReading()
                    if (this.afterSuccessTimer) {
                        clearTimeout(this.afterSuccessTimer)
                        this.afterSuccessTimer = null
                    }

                    if (this.trafficLightToGreenTimer) {
                        clearTimeout(this.trafficLightToGreenTimer);
                        this.trafficLightToGreenTimer = null;
                    }

                    this.nfcBusy = false

                    // Reset Read State
                    this.readerActive = false
                    this.readData = null
                    this.parsedReadData = null
                    this.readMessage = ''
                    this.readStatus = ''
                    
                    // Reset Write State
                    this.writeStatus = ''
                    this.writeMessage = ''

                    // Reset Timbang State
                    this.timbangStatus = '';
                    this.timbangSuccess = false;

                    // Reset Traffic Light
                    this.setTrafficLightState('red');
                },

                // --- READER (GATE CONTROL) LOGIC ---
                startContinuousScan() {
                    // Always try to stay in scan mode (scan again automatically)
                    if (!this.ndefReaderSupported) {
                        this.readMessage = 'NFC tidak didukung pada perangkat ini.'
                        this.readStatus = 'fail'
                        return
                    }

                    // If already scanning, do nothing
                    if (this.readerActive) return;

                    this.resetReadState();

                    this.nfcBusy = true;
                    this.ndefReader = new NDEFReader();

                    try {
                        this.ndefReader.scan().then(() => {
                            this.readerActive = true;
                            this.readMessage = 'Siap. Dekatkan tag NFC...';
                            this.readStatus = 'info';
                            this.setTrafficLightState('red');
                            if (this.trafficLightToGreenTimer) clearTimeout(this.trafficLightToGreenTimer);

                            this.ndefReader.onreading = event => {
                                this.onNFCRead(event);
                            };
                            this.ndefReader.onreadingerror = err => {
                                this.readMessage = 'Kesalahan saat membaca tag: ' + (err.message || 'Tag tidak valid.');
                                this.readStatus = 'fail';
                                this.nfcBusy = false;
                                // Tetap dalam scan mode!
                                this.readerActive = false;
                                setTimeout(() => this.startContinuousScan(), 400); // Slight delay to avoid too-rapid looping
                            };
                        }).catch(error => {
                            this.readMessage = "Gagal memulai scan NFC: " + (error.message || error);
                            this.readStatus = 'fail'
                            this.readerActive = false
                            this.nfcBusy = false
                            this.ndefReader = null
                        });
                    } catch (error) {
                        this.readMessage = "Gagal memulai scan NFC: " + (error.message || error)
                        this.readStatus = 'fail'
                        this.readerActive = false
                        this.nfcBusy = false
                        this.ndefReader = null
                    }
                },

                toggleReader() {
                    // Keep for compatibility/trigger, just call startContinuousScan
                    this.startContinuousScan();
                },

                stopReading() {
                    if (this.afterSuccessTimer) {
                        clearTimeout(this.afterSuccessTimer)
                        this.afterSuccessTimer = null
                    }
                    if (this.trafficLightToGreenTimer) {
                        clearTimeout(this.trafficLightToGreenTimer)
                        this.trafficLightToGreenTimer = null
                    }
                    this.readerActive = false
                    this.nfcBusy = false
                    this.ndefReader = null // No official stop method, so we unset the object and listeners
                },

                onNFCRead(event) {
                    this.nfcBusy = false
                    this.readerActive = false

                    try {
                        const decoder = new TextDecoder()
                        let rawText = ''
                        let parsedData = {}

                        if(event.message && event.message.records.length > 0) {
                            for (const record of event.message.records) {
                                if (record.recordType === "text") {
                                    rawText = decoder.decode(record.data).trim()
                                    // Try to parse the content as JSON (our expected format)
                                    try {
                                        parsedData = JSON.parse(rawText)
                                    } catch (e) {
                                        // Not valid JSON or our format, handle as plain text
                                        parsedData = { driverId: 'N/A (Teks Biasa)', unit: rawText }
                                    }
                                    break // Only read the first text record
                                }
                            }
                            
                            this.readData = rawText
                            this.parsedReadData = parsedData

                            // Validation for Gate Access: must have driverId and unit
                            if (parsedData.driverId && parsedData.unit) {
                                this.readMessage = `Sukses! Akses disetujui untuk ${parsedData.driverId}.`
                                fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/gate.json', {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(1)
                                })
                                .then(response => {})
                                .catch(error => {});
                                fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/plate.json', {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(parsedData.unit)
                                })
                                .then(response => {})
                                .catch(error => {});
                                this.readStatus = 'success'

                                // lampu ke yellow lalu hijau di watcher readStatus

                                // Tambahan: tunggu 10 detik, lalu kirim gate=0, lalu siap scanning lagi
                                this.readMessage = `Sukses! Akses disetujui untuk ${parsedData.driverId}. Gerbang akan menutup dalam 10 detik...`
                                if (this.afterSuccessTimer) {
                                    clearTimeout(this.afterSuccessTimer)
                                }
                                this.afterSuccessTimer = setTimeout(() => {
                                    fetch('https://hasnur-b7714-default-rtdb.firebaseio.com/gate.json', {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(0)
                                    })
                                    .then(response => {})
                                    .catch(error => {});
                                    this.readMessage = "Gerbang ditutup. Siap scan tag NFC berikutnya...";
                                    this.readStatus = 'info';
                                    // Restart scan (selalu dalam proses scan)
                                    this.startContinuousScan();
                                    this.afterSuccessTimer = null;
                                }, 5000);

                            } else {
                                this.readMessage = 'Tag terbaca, tetapi data tidak lengkap atau format salah (Akses Ditolak).'
                                this.readStatus = 'fail'
                                setTimeout(() => this.startContinuousScan(), 400);
                            }

                        } else {
                            this.readData = null
                            this.parsedReadData = null
                            this.readMessage = 'Tag NFC ditemukan, tetapi tidak berisi data teks (Akses Ditolak).'
                            this.readStatus = 'fail'
                            setTimeout(() => this.startContinuousScan(), 400);
                        }
                    } catch (e) {
                        this.readData = null
                        this.parsedReadData = null
                        this.readMessage = 'Kesalahan pemrosesan data NFC.'
                        this.readStatus = 'fail'
                        setTimeout(() => this.startContinuousScan(), 400);
                    }
                },

                resetReadState() {
                    if(this.afterSuccessTimer) {
                        clearTimeout(this.afterSuccessTimer)
                        this.afterSuccessTimer = null
                    }
                    if (this.trafficLightToGreenTimer) {
                        clearTimeout(this.trafficLightToGreenTimer);
                        this.trafficLightToGreenTimer = null;
                    }
                    this.readData = null
                    this.parsedReadData = null
                    this.readStatus = ''
                    this.readMessage = ''
                    this.setTrafficLightState('red');
                },

                // --- WRITER (REGISTRATION) LOGIC ---
                async writeToNFC() {
                    if (!this.ndefReaderSupported) {
                        this.writeMessage = "NFC tidak didukung pada perangkat ini."
                        this.writeStatus = 'fail'
                        return
                    }
                    if (!this.formValid) {
                        this.writeMessage = 'Mohon isi semua kolom (ID Pengemudi & Nomor Unit).'
                        this.writeStatus = 'fail'
                        return
                    }

                    this.writeStatus = ''
                    this.writeMessage = 'Dekatkan tag NFC kosong atau dapat ditimpa untuk penulisan...'
                    this.nfcBusy = true

                    const dataToWrite = {
                        driverId: this.driverIdInput.trim(),
                        unit: this.unitNumberInput.trim()
                    }
                    // Prepare the data as a JSON string record
                    const textRecord = JSON.stringify(dataToWrite)

                    try {
                        const ndef = new NDEFReader()
                        // Remove timeout (tidak ada gagal 15 detik untuk tulis)
                        await ndef.write({
                            records: [{
                                recordType: "text", 
                                data: textRecord
                            }]
                        })

                        this.writeMessage = "Sukses! Data Unit/Pengemudi telah ditulis ke tag NFC."
                        this.writeStatus = "success"
                        this.nfcBusy = false

                    } catch (err) {
                        this.writeMessage = "Gagal Menulis: " + (err.message || "Pastikan tag dapat ditulisi.")
                        this.writeStatus = 'fail'
                        this.nfcBusy = false
                    }
                },
            }
        }).mount('#app')
    </script>
</body>
</html>
