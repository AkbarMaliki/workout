<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Financial & Nutrisi Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- ApexCharts CDN for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-500': '#3b82f6',
                        'primary-100': '#e0f2fe',
                        'primary-50': '#f0f9ff',
                        'secondary-500': '#10b981',
                        'secondary-100': '#d1fae5',
                        'secondary-50': '#f0fdf4',
                        'gray-850': '#1f2937',
                        'header-light': '#f4faff', // custom light
                        // Add deeper, "bluer" shades for dark for closer to your image:
                        'blue-dark-bg1': '#181d32',
                        'blue-dark-bg2': '#1a223f',
                        'blue-dark-box': '#232a43',
                        'green-dark': '#4ee19e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #e8eaf0;
        }

        body {
            transition: background 0.3s, color 0.3s;
        }

        /* Fade effect for Vue */
        .fade-enter-active, .fade-leave-active { transition: opacity .3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .fadeY-enter-active, .fadeY-leave-active { transition: all 0.4s; }
        .fadeY-enter-from { opacity: 0; transform: translateY(20px);}
        .fadeY-leave-to   { opacity: 0; transform: translateY(-10px);}
    </style>
</head>
<body :class="(darkMode ? 'dark bg-gradient-to-tr from-blue-950 via-gray-900 to-green-950 text-gray-100' : 'bg-gradient-to-tr from-primary-100 via-white to-secondary-100 text-gray-900') + ' min-h-screen font-sans transition-colors duration-200'" id="vue-body">

<div id="app" class="min-h-screen flex flex-col">

    <!-- Decorative Background SVGs -->
    <div v-if="!darkMode" class="pointer-events-none fixed top-0 left-0 right-0 -z-10">
        <!-- Light Mode SVG -->
        <svg class="w-full h-36 md:h-60 blur-xl opacity-70" viewBox="0 0 1440 320" fill="none">
            <path fill="#38bdf8" fill-opacity="0.20"
                  d="M0,128L60,154.7C120,181,240,235,360,218.7C480,203,600,117,720,90.7C840,64,960,96,1080,117.3C1200,139,1320,149,1380,154.7L1440,160L1440,0L1380,0C1320,0,1200,0,1080,0C960,0,840,0,720,0C600,0,480,0,360,0C240,0,120,0,60,0L0,0Z"/>
        </svg>
    </div>
    <div v-else class="pointer-events-none fixed top-0 left-0 right-0 -z-10">
        <!-- Dark Mode SVG -->
        <svg class="w-full h-36 md:h-60 blur-xl opacity-70" viewBox="0 0 1440 320" fill="none">
            <path fill="#3b82f6" fill-opacity="0.22" d="M0,96L60,133.3C120,171,240,245,360,261.3C480,277,600,235,720,181.3C840,128,960,64,1080,58.7C1200,53,1320,107,1380,133.3L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path>
        </svg>
    </div>

    <!-- Header & Date Picker -->
    <header 
      :class="[
        darkMode 
            ? 'bg-gradient-to-br from-primary-500/40 to-gray-950/80 text-white border-b-2 border-primary-600 shadow-xl'
            : 'bg-gradient-to-br from-primary-50 via-header-light to-secondary-50 text-primary-800 border-b-2 border-primary-100 shadow'
      ].join(' ') + ' w-full px-4 lg:px-20 py-7 rounded-b-3xl relative flex flex-col md:flex-row md:items-center md:justify-between z-10 transition-colors duration-200'">
        <div class="flex items-center space-x-4 mb-3 md:mb-0">
            <img 
                v-if="darkMode"
                src="https://img.icons8.com/ios-filled/50/3b82f6/artificial-intelligence.png" 
                width="48" alt="AI Icon" class="drop-shadow" loading="lazy">
            <img 
                v-else
                src="https://img.icons8.com/fluency/48/artificial-intelligence.png"
                width="48" alt="AI Icon" class="drop-shadow" loading="lazy">
            <h1 class="text-4xl font-black bg-gradient-to-r from-primary-500 via-secondary-500 to-white bg-clip-text text-transparent drop-shadow-lg">Daily Tracker AI</h1>
        </div>
        <div class="flex items-center space-x-2 md:space-x-3"
            :class="darkMode ? 'bg-gray-700/50 rounded-xl shadow-md py-2 px-4' : 'bg-white/90 border border-primary-100 rounded-xl shadow py-2 px-4'">
            <label for="dateInput" class="hidden md:inline"
                :class="darkMode ? 'text-gray-300 font-semibold' : 'text-primary-600 font-semibold'"
            >Tanggal:</label>
            <input id="dateInput" type="date" v-model="selectedDate" 
                :class="darkMode
                    ? 'bg-gray-800 text-gray-100 px-3 py-2 rounded-lg border border-primary-500/40 focus:ring-primary-500 focus:border-primary-500 transition duration-150 font-medium outline-none shadow-inner'
                    : 'bg-white text-gray-700 px-3 py-2 rounded-lg border border-primary-200 focus:ring-primary-400 focus:border-primary-400 transition duration-150 font-medium outline-none shadow-inner border'"
            />
            <!-- Theme Switcher -->
            <button 
                @click="toggleDarkMode"
                :title="darkMode ? 'Mode Terang' : 'Mode Gelap'"
                class="ml-2 flex items-center justify-center w-10 h-10 rounded-full shadow-md border"
                :class="darkMode 
                    ? 'bg-gray-900 border-primary-600 hover:bg-primary-700/30 text-yellow-300'
                    : 'bg-primary-50 border-primary-200 hover:bg-primary-200 text-primary-600'"
            >
                <svg v-if="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <!-- Sun icon -->
                    <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" fill="currentColor" />
                    <g stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="2" x2="12" y2="4"/>
                        <line x1="12" y1="20" x2="12" y2="22"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="2" y1="12" x2="4" y2="12"/>
                        <line x1="20" y1="12" x2="22" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </g>
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <!-- Moon icon -->
                    <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </header>

    <main
      :class="(darkMode
        ? 'bg-transparent'
        : 'bg-gradient-to-b from-primary-50 via-white to-secondary-50'
      ) + ' flex-1 w-full max-w-7xl mx-auto px-4 md:px-8 py-8 lg:pt-12 grid grid-cols-1 lg:grid-cols-3 gap-8 transition-colors duration-200'"
    >
        <!-- Sidebar: Input Section -->
        <aside class="lg:col-span-1 space-y-8">
            <!-- Loading Indicator -->
            <transition name="fade">
            <div v-if="isLoading" 
                :class="darkMode
                    ? 'p-6 bg-primary-500/20 border-2 border-primary-500 text-primary-200 rounded-2xl flex items-center justify-center space-x-4 shadow-xl ring-2 ring-primary-500/30 animate-pulse'
                    : 'p-6 bg-primary-100 border-2 border-primary-500 text-primary-600 rounded-2xl flex items-center justify-center space-x-4 shadow ring-2 ring-primary-200 animate-pulse'"
            >
                <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24" fill="none">
                    <circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-65" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.7 0 0 5.7 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.04 1.14 5.82 3 7.94l3-2.65z"></path>
                </svg>
                <span class="text-lg font-bold tracking-wide">Memuat data...</span>
            </div>
            </transition>
            <!-- Financial Input -->
            <div v-if="currentView === 'financial'"
                :class="darkMode
                    ? 'bg-gradient-to-tr from-primary-500/5 via-gray-900 to-gray-900 border-t-4 border-primary-500 shadow-lg p-7 rounded-2xl'
                    : 'bg-gradient-to-tr from-primary-50 via-white/90 to-primary-100/90 border-t-4 border-primary-300 shadow p-7 rounded-2xl'"
            >
                <h3
                    :class="darkMode 
                        ? 'text-2xl font-extrabold mb-5 text-primary-400 flex items-center gap-2'
                        : 'text-2xl font-extrabold mb-5 text-primary-600 flex items-center gap-2'"
                >
                    <span class="material-symbols-rounded align-middle"></span> Input Pengeluaran
                </h3>
                <form @submit.prevent="saveTransaction" class="space-y-4">
                    <div>
                        <label :class="darkMode ? 'text-gray-300' : 'text-primary-600'" class="block mb-1 font-medium" for="descInput">Deskripsi</label>
                        <input type="text" id="descInput" v-model="newTransaction.description" placeholder="Deskripsi (ex: Makan Siang)" required
                            :class="darkMode 
                                ? 'w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:ring-primary-500 focus:border-primary-500 transition placeholder:text-gray-500'
                                : 'w-full p-3 bg-white border border-primary-200 rounded-lg focus:ring-primary-400 focus:border-primary-400 transition placeholder:text-gray-400'"
                        />
                    </div>
                    <div>
                        <label :class="darkMode ? 'text-gray-300' : 'text-primary-600'" class="block mb-1 font-medium" for="amountInput">Jumlah Biaya (Rp)</label>
                        <input type="number" id="amountInput" v-model.number="newTransaction.amount" placeholder="0"
                            required
                            :class="darkMode 
                                ? 'w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:ring-primary-500 focus:border-primary-500 transition placeholder:text-gray-500'
                                : 'w-full p-3 bg-white border border-primary-200 rounded-lg focus:ring-primary-400 focus:border-primary-400 transition placeholder:text-gray-400'"
                        />
                    </div>
                    <div>
                        <label :class="darkMode ? 'text-gray-300' : 'text-primary-600'" class="block mb-1 font-medium" for="catInput">Kategori</label>
                        <select id="catInput" v-model="newTransaction.category" required
                            :class="darkMode 
                                ? 'w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:ring-primary-500 focus:border-primary-500 transition appearance-none'
                                : 'w-full p-3 bg-white border border-primary-200 rounded-lg focus:ring-primary-400 focus:border-primary-400 transition appearance-none'"
                        >
                            <option value="" disabled>Pilih Kategori</option>
                            <option value="Makan">üçõ Makan</option>
                            <option value="Transportasi">üõª Transportasi</option>
                            <option value="Kebutuhan Rumah">üè† Kebutuhan Rumah</option>
                            <option value="Tagihan">üßæ Tagihan (Listrik/Internet)</option>
                            <option value="Kesehatan/Gym">üí™ Kesehatan/Gym</option>
                            <option value="Investasi/Cicilan">üí∏ Investasi/Cicilan</option>
                            <option value="Lainnya">ü™Ñ Lainnya</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full font-bold py-3 rounded-lg shadow-md text-lg transition-all"
                        :class="darkMode 
                            ? 'bg-primary-500 bg-primary-600 text-white'
                            : 'bg-primary-400 bg-primary-500 text-white'"
                    >Tambah Pengeluaran</button>
                </form>
            </div>
            <!-- Nutrition Input: Only AI Image, Manual removed -->
            <div v-if="currentView === 'nutrition'"
                :class="darkMode
                    ? 'bg-gradient-to-tr from-secondary-500/5 via-gray-900 to-gray-900 border-t-4 border-secondary-500 shadow-lg p-7 rounded-2xl space-y-5'
                    : 'bg-gradient-to-tr from-secondary-50 via-white to-secondary-100 border-t-4 border-secondary-300 shadow p-7 rounded-2xl space-y-5'"
            >
                <h3 :class="darkMode ? 'text-2xl font-extrabold text-secondary-400 flex items-center gap-2 mb-4' : 'text-2xl font-extrabold text-secondary-600 flex items-center gap-2 mb-4'">
                    <span class="material-symbols-rounded align-middle"></span> Input Nutrisi (AI Gambar)
                </h3>
                <div class="space-y-5">
                    <form @submit.prevent="saveMeal" class="space-y-4 mb-4">
                        <div>
                            <label :class="darkMode ? 'text-gray-300' : 'text-secondary-700'" class="block mb-1 font-medium" for="manualDescInput">Deskripsi Makanan</label>
                            <input
                                type="text"
                                id="manualDescInput"
                                v-model="newMeal.description"
                                placeholder="Contoh: Ayam Bakar + Nasi Putih"
                                required
                                :class="darkMode 
                                    ? 'w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:ring-secondary-500 focus:border-secondary-500 transition placeholder:text-gray-400'
                                    : 'w-full p-3 bg-white border border-secondary-200 rounded-lg focus:ring-secondary-400 focus:border-secondary-400 transition placeholder:text-gray-500'"
                            />
                        </div>
                        <div>
                            <label :class="darkMode ? 'text-gray-300' : 'text-secondary-700'" class="block mb-1 font-medium" for="manualCalorieInput">Kalori (kkal)</label>
                            <input
                                type="number"
                                id="manualCalorieInput"
                                v-model.number="newMeal.calories"
                                min="0"
                                placeholder="Kalori"
                                required
                                :class="darkMode
                                    ? 'w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:ring-secondary-500 focus:border-secondary-500 transition placeholder:text-gray-400'
                                    : 'w-full p-3 bg-white border border-secondary-200 rounded-lg focus:ring-secondary-400 focus:border-secondary-400 transition placeholder:text-gray-500'"
                            />
                        </div>
                        <div>
                            <label :class="darkMode ? 'text-gray-300' : 'text-secondary-700'" class="block mb-1 font-medium" for="manualProteinInput">Protein (gram)</label>
                            <input
                                type="number"
                                id="manualProteinInput"
                                v-model.number="newMeal.protein"
                                min="0"
                                placeholder="Protein"
                                required
                                :class="darkMode
                                    ? 'w-full p-3 bg-gray-800 rounded-lg border border-gray-700 focus:ring-secondary-500 focus:border-secondary-500 transition placeholder:text-gray-400'
                                    : 'w-full p-3 bg-white border border-secondary-200 rounded-lg focus:ring-secondary-400 focus:border-secondary-400 transition placeholder:text-gray-500'"
                            />
                        </div>
                        <button
                            type="submit"
                            class="w-full font-bold py-3 rounded-lg shadow-md text-lg transition-all"
                            :class="darkMode
                                ? 'bg-secondary-600 bg-secondary-700 text-white'
                                : 'bg-secondary-400 bg-secondary-500 text-white'"
                        >Tambah Manual</button>
                    </form>
                    <label :class="darkMode ? 'block text-gray-300 font-medium mb-1' : 'block text-secondary-700 font-medium mb-1'">Upload Foto Makanan</label>
                    <input type="file" @change="handleImageUpload" accept="image/*"
                        :class="darkMode
                            ? 'block w-full file:mr-4 file:py-3 file:px-5 file:rounded-full file:border-0 file:text-lg file:font-bold file:bg-primary-500 file:text-white hover:file:bg-primary-700 file:transition-all duration-150 bg-gray-800 text-gray-500 rounded-xl py-2 px-3'
                            : 'block w-full file:mr-4 file:py-3 file:px-5 file:rounded-full file:border-0 file:text-lg file:font-bold file:bg-primary-400 file:text-white hover:file:bg-primary-500 file:transition-all duration-150 bg-white text-gray-700 rounded-xl py-2 px-3'"
                    />
                    <transition name="fade">
                    <div v-if="imagePreviewUrl" class="relative mt-2">
                        <img
                            :src="imagePreviewUrl"
                            alt="Pratinjau Makanan"
                            :class="darkMode ? 'w-full h-52 object-cover rounded-xl shadow-2xl border-2 border-primary-600 mb-2' : 'w-full h-52 object-cover rounded-xl shadow-2xl border-2 border-primary-300 mb-2'"
                        />
                        <button @click="clearImage"
                            :class="darkMode
                                ? 'absolute top-2 right-2 bg-red-600 hover:bg-red-700 p-2 rounded-full text-white text-base font-bold shadow-lg transition'
                                : 'absolute top-2 right-2 bg-red-200 hover:bg-red-400 text-red-900 p-2 rounded-full font-bold shadow transition'"
                            title="Hapus Gambar">
                            <!-- X icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 m-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    </transition>
                    <button @click="startImageAnalysis" :disabled="!imageFile || isLoading"
                        class="w-full py-3 mt-2 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2"
                        :class="(imageFile && !isLoading)
                            ? (darkMode
                                ? 'bg-primary-500 hover:bg-primary-600 text-white'
                                : 'bg-secondary-500 hover:bg-secondary-600 text-white'
                              )
                            : (darkMode
                                ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                              )">
                        <svg v-if="isLoading" class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none">
                            <circle class="opacity-30" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        </svg>
                        <span v-if="isLoading">Menganalisis...</span>
                        <span v-else>Analisis Kalori & Protein via AI</span>
                    </button>
                    <transition name="fade">
                    <div v-if="analysisResult.description"
                        :class="darkMode 
                            ? 'p-4 mt-3 bg-gray-800/95 rounded-xl border-2 border-secondary-500 text-base shadow-lg' 
                            : 'p-4 mt-3 bg-secondary-50 rounded-xl border-2 border-secondary-400 text-base shadow'"
                    >
                        <p :class="darkMode ? 'font-bold text-primary-400 mb-2' : 'font-bold text-primary-600 mb-2'">Hasil AI Deteksi Makanan:</p>
                        <p class="pl-1">üçΩ <span class="font-semibold">{{ analysisResult.description }}</span></p>
                        <p class="pl-1">üî• Kalori: <span :class="darkMode ? 'text-secondary-400 font-bold' : 'text-secondary-600 font-bold'">{{ analysisResult.calories }} kcal</span></p>
                        <p class="pl-1">ü•© Protein: <span :class="darkMode ? 'text-secondary-400 font-bold' : 'text-secondary-600 font-bold'">{{ analysisResult.protein }} g</span></p>
                        <button @click="quickSaveMeal"
                            :class="darkMode 
                                ? 'mt-4 w-full bg-secondary-500/20 text-secondary-200 py-2.5 rounded-md text-base font-semibold hover:bg-secondary-500/40 transition duration-200 shadow'
                                : 'mt-4 w-full bg-secondary-100 hover:bg-secondary-200 text-secondary-900 py-2.5 rounded-md text-base font-semibold transition duration-200 shadow'"
                        >Simpan Hasil AI</button>
                    </div>
                    </transition>
                    <p v-if="apiError"
                      :class="darkMode
                        ? 'text-base text-red-500 bg-red-900/70 py-2 px-2.5 rounded-lg mt-2 border border-red-600'
                        : 'text-base text-red-700 bg-red-100 py-2 px-2.5 rounded-lg mt-2 border border-red-300'"
                    >Error API: {{ apiError }}</p>
                </div>
            </div>
        </aside>

        <!-- Dashboard & Summary (2/3 Content) -->
        <section class="lg:col-span-2 flex flex-col space-y-8">
            <!-- Financial Dashboard -->
            <transition name="fade">
            <div v-if="currentView === 'financial'" class="space-y-8">
                <!-- Summary Card Financial -->
                <div
                    :class="darkMode
                        ? 'bg-gradient-to-l from-primary-500/10 via-gray-900 to-gray-800 border-b-4 border-primary-600 p-8 rounded-2xl shadow-xl'
                        : 'bg-gradient-to-l from-primary-50 via-white to-primary-100 border-b-4 border-primary-400 p-8 rounded-2xl shadow'"
                >
                    <h3 :class="darkMode
                        ? 'text-2xl font-black mb-5 text-primary-300 drop-shadow flex items-center gap-2'
                        : 'text-2xl font-black mb-5 text-primary-700 drop-shadow flex items-center gap-2'"
                    >Summary Finansial Bulanan <span :class="darkMode ? 'text-white hidden md:inline' : 'text-primary-500 hidden md:inline'">({{ formattedMonth(selectedDate) }})</span></h3>
                    <div class="flex flex-col md:flex-row md:space-x-8 space-y-6 md:space-y-0">
                        <div :class="darkMode
                            ? 'flex-1 bg-gray-800 p-6 rounded-xl shadow-md border-b-4 border-primary-500'
                            : 'flex-1 bg-white p-6 rounded-xl shadow border-b-4 border-primary-300'"
                        >
                            <p :class="darkMode ? 'text-sm text-gray-400 mb-1' : 'text-sm text-primary-600 mb-1'">Total Pengeluaran Bulan Ini</p>
                            <p :class="darkMode ? 'text-3xl font-black text-white drop-shadow' : 'text-3xl font-black text-primary-700 drop-shadow'">Rp {{ totalMonthlyExpense.toLocaleString('id-ID') }}</p>
                        </div>
                        <div :class="darkMode
                            ? 'flex-1 bg-gray-800 p-6 rounded-xl shadow-md border-b-4 border-secondary-500'
                            : 'flex-1 bg-white p-6 rounded-xl shadow border-b-4 border-secondary-300'"
                        >
                            <p :class="darkMode ? 'text-sm text-gray-400 mb-1' : 'text-sm text-secondary-600 mb-1'">Target Bulanan</p>
                            <p :class="darkMode ? 'text-3xl font-black text-secondary-400 drop-shadow' : 'text-3xl font-black text-secondary-600 drop-shadow'">Rp {{ monthlyFinancialTarget.toLocaleString('id-ID') }}</p>
                        </div>
                        <div :class="darkMode
                            ? 'flex-1 bg-gray-800 p-6 rounded-xl shadow-md border-b-4 border-secondary-500'
                            : 'flex-1 bg-white p-6 rounded-xl shadow border-b-4 border-secondary-300'"
                        >
                            <p :class="darkMode ? 'text-sm text-gray-400 mb-1' : 'text-sm text-secondary-600 mb-1'">Sisa Bulanan</p>
                            <p class="text-3xl font-black drop-shadow"
                                :class="totalMonthlyExpense > monthlyFinancialTarget 
                                    ? (darkMode ? 'text-red-400' : 'text-red-600')
                                    : (darkMode ? 'text-green-400' : 'text-green-600')"
                            >
                                Rp {{ (monthlyFinancialTarget-totalMonthlyExpense >= 0 ? (monthlyFinancialTarget-totalMonthlyExpense).toLocaleString('id-ID') : '0') }}
                            </p>
                        </div>
                    </div>
                </div>
                <!-- ApexCharts: Donut and Bar daily chart financial -->
                <div class="flex flex-col gap-8">
                    <!-- Donut Target vs Actual -->
                    <div :class="darkMode
                        ? 'bg-gray-900 p-7 rounded-2xl shadow-xl border border-primary-500/40 max-w-xl mx-auto w-full'
                        : 'bg-white p-7 rounded-2xl shadow border border-primary-100 max-w-xl mx-auto w-full'"
                    >
                        <h3 :class="darkMode ? 'text-xl font-bold mb-4 text-gray-100' : 'text-xl font-bold mb-4 text-primary-700'">
                            Persentase Pengeluaran Bulanan</h3>
                        <div id="apexChartFinDonut" class="h-80"></div>
                    </div>
                    <!-- Bar Daily Spending -->
                    <div :class="darkMode
                        ? 'bg-gray-900 p-7 rounded-2xl shadow-xl border border-secondary-500/20 max-w-xl mx-auto w-full'
                        : 'bg-white p-7 rounded-2xl shadow border border-secondary-100 max-w-xl mx-auto w-full'"
                    >
                        <h3 :class="darkMode ? 'text-xl font-bold mb-4 text-gray-100' : 'text-xl font-bold mb-4 text-secondary-700'">Bar Pengeluaran Harian</h3>
                        <div id="apexChartFinBar" class="h-80"></div>
                    </div>
                </div>
            </div>
            </transition>
            <!-- Nutrition Dashboard -->
            <transition name="fade">
            <div v-if="currentView != 'financial'" class="space-y-8">
                <!-- Summary Card Nutrition -->
                <div :class="darkMode
                    ? 'bg-gradient-to-l from-secondary-500/10 via-gray-900 to-gray-800 border-b-4 border-secondary-600 p-8 rounded-2xl shadow-xl'
                    : 'bg-gradient-to-l from-secondary-50 via-white to-secondary-100 border-b-4 border-secondary-400 p-8 rounded-2xl shadow'"
                >
                    <h3 :class="darkMode
                        ? 'text-2xl font-black mb-5 text-secondary-300 drop-shadow flex items-center gap-2'
                        : 'text-2xl font-black mb-5 text-secondary-700 drop-shadow flex items-center gap-2'"
                    >Summary Nutrisi Harian <span :class="darkMode ? 'text-white hidden md:inline' : 'text-secondary-400 hidden md:inline'">({{ formattedDate(selectedDate) }})</span></h3>
                    <div class="flex flex-col md:flex-row md:space-x-8 space-y-6 md:space-y-0">
                        <div :class="darkMode
                            ? 'flex-1 bg-gray-800 p-6 rounded-xl shadow-md border-b-4 border-secondary-500'
                            : 'flex-1 bg-white p-6 rounded-xl shadow border-b-4 border-secondary-300'"
                        >
                            <p :class="darkMode ? 'text-sm text-gray-400 mb-1' : 'text-sm text-secondary-600 mb-1'">Total Kalori / Protein</p>
                            <p :class="darkMode ? 'text-3xl font-black text-white drop-shadow' : 'text-3xl font-black text-secondary-700 drop-shadow'">{{ totalDailyNutrition.calories }} kcal / {{ totalDailyNutrition.protein }} g</p>
                        </div>
                    </div>
                    <!-- Bulking Goal Check -->
                    <div class="mt-6 p-4 rounded-xl border-2"
                        :class="bulkingGoalStatus.class + (darkMode ? ' bg-gray-900/70' : ' bg-secondary-50')"
                    >
                        <p class="text-base font-bold mb-1">{{ bulkingGoalStatus.message }}</p>
                        <p :class="darkMode ? 'text-xs text-gray-300' : 'text-xs text-secondary-700'">Target Kalori: 2000-2300 kcal. Target Protein: 94-130 g.</p>
                    </div>
                </div>
                <!-- Protein Target vs Actual Per Hari -->
                <div v-if="currentView != 'financial'"
                     :class="darkMode
                        ? 'bg-gray-900 p-7 rounded-2xl shadow-xl border border-secondary-500/40 mb-6'
                        : 'bg-white p-7 rounded-2xl shadow border border-secondary-100 mb-6'"
                >
                    <h3 :class="darkMode ? 'text-xl font-bold mb-4 text-gray-100' : 'text-xl font-bold mb-4 text-secondary-700'">
                        Protein Harian (Target vs Aktual)
                    </h3>
                    <div id="apexChartProtein" class="h-80"></div>
                </div>
                <!-- Kalori Target vs Actual Per Hari -->
                <div v-if="currentView != 'financial'"
                     :class="darkMode
                        ? 'bg-gray-900 p-7 rounded-2xl shadow-xl border border-primary-500/10'
                        : 'bg-white p-7 rounded-2xl shadow border border-primary-100'"
                >
                    <h3 :class="darkMode ? 'text-xl font-bold mb-4 text-gray-100' : 'text-xl font-bold mb-4 text-primary-700'">
                        Kalori Harian (Target vs Aktual)
                    </h3>
                    <div id="apexChartCalorie" class="h-80"></div>
                </div>
            </div>
            </transition>
        </section>
    </main>

    <!-- Navigation Menu (Fixed on viewport bottom for mobile/full width web) -->
    <nav
        :class="[
            darkMode
                ? 'fixed z-40 bottom-0 left-0 right-0 bg-gradient-to-r from-primary-700/80 via-gray-900/95 to-secondary-800/80 border-t-2 border-primary-800 shadow-2xl'
                : 'fixed z-40 bottom-0 left-0 right-0 bg-gradient-to-r from-primary-100 via-secondary-50 to-secondary-100 border-t-2 border-primary-100 shadow'
        ].join(' ') + ' md:relative md:mt-10 md:bg-transparent md:border-t-0 md:shadow-none pb-1 transition-colors duration-200'"
    >
        <div class="flex justify-center max-w-2xl mx-auto py-2 px-2 md:justify-end md:space-x-2">
            <button @click="switchView('financial')" 
                :class="{
                    'text-primary-500 border-b-4 border-primary-500 bg-primary-900/25 shadow-lg': currentView === 'financial' && darkMode,
                    'text-primary-600 border-b-4 border-primary-300 bg-primary-100 shadow': currentView === 'financial' && !darkMode,
                    'text-gray-400 hover:text-primary-300 hover:bg-primary-800/20': currentView !== 'financial' && darkMode,
                    'text-gray-400 hover:text-primary-600 hover:bg-primary-50': currentView !== 'financial' && !darkMode
                }"
                class="flex flex-col items-center justify-center py-2 px-7 rounded-xl md:px-4 transition-all text-lg font-bold focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 m-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span class="text-xs mt-1 md:hidden">Finansial</span>
            </button>
            <button @click="switchView('nutrition')" 
                :class="{
                    'text-secondary-500 border-b-4 border-secondary-500 bg-secondary-900/20 shadow-lg': currentView === 'nutrition' && darkMode,
                    'text-secondary-600 border-b-4 border-secondary-300 bg-secondary-100 shadow': currentView === 'nutrition' && !darkMode,
                    'text-gray-400 hover:text-secondary-400 hover:bg-secondary-900/10': currentView !== 'nutrition' && darkMode,
                    'text-gray-400 hover:text-secondary-600 hover:bg-secondary-50': currentView !== 'nutrition' && !darkMode
                }"
                class="flex flex-col items-center justify-center py-2 px-7 rounded-xl md:px-4 transition-all text-lg font-bold focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 m-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v2m0 0a3 3 0 003-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs mt-1 md:hidden">Nutrisi</span>
            </button>
        </div>
    </nav>

    <!-- Data List (Daily Log), full width under nav, only for selected date -->
    <section class="w-full max-w-6xl mx-auto mt-8 mb-32 md:mb-12 px-4">
        <h3 :class="darkMode ? 'text-3xl font-extrabold mb-6 text-gray-200 drop-shadow' : 'text-3xl font-extrabold mb-6 text-primary-800 drop-shadow' ">
            <span v-if="currentView === 'financial'">Log Pengeluaran Harian</span>
            <span v-else>Log Nutrisi Harian</span>
        </h3>
        
        <!-- Financial List, transaksi hanya untuk tanggal dipilih -->
        <div v-if="currentView === 'financial'" class="space-y-4 custom-scrollbar overflow-y-auto max-h-96 pr-2">
            <div v-if="filteredTransactions.length === 0"
                :class="darkMode
                    ? 'p-7 bg-gray-800/75 rounded-2xl shadow text-center text-gray-400 text-lg font-semibold border-2 border-dashed border-primary-700/40'
                    : 'p-7 bg-primary-50 rounded-2xl shadow text-center text-primary-400 text-lg font-semibold border-2 border-dashed border-primary-200'"
            >
                Belum ada pengeluaran untuk tanggal ini üôå
            </div>
            <transition-group name="fadeY">
            <div v-for="t in filteredTransactions" :key="t.id"
                :class="darkMode
                    ? 'bg-gradient-to-l from-primary-600/5 to-gray-900 p-6 rounded-2xl shadow-lg border-l-8 border-primary-500 flex justify-between items-center group hover:bg-primary-900/10 transition'
                    : 'bg-gradient-to-l from-primary-100/60 to-white p-6 rounded-2xl shadow border-l-8 border-primary-200 flex justify-between items-center group hover:bg-primary-100/50 transition'"
            >
                <div class="flex-1 min-w-0">
                    <p :class="darkMode ? 'font-bold text-lg text-white truncate' : 'font-bold text-lg text-primary-900 truncate'">{{ t.description }}</p>
                    <p :class="darkMode ? 'text-sm text-primary-300 font-medium' : 'text-sm text-primary-700 font-medium'">{{ t.category }}</p>
                </div>
                <div class="flex items-center space-x-4 flex-shrink-0">
                    <span :class="darkMode ? 'text-xl font-extrabold text-red-400' : 'text-xl font-extrabold text-red-600'">Rp {{ t.amount.toLocaleString('id-ID') }}</span>
                    <button @click="deleteItem('transactions', t.id)"
                        :class="darkMode 
                            ? 'text-gray-500 hover:text-red-500 transition bg-gray-800 hover:bg-red-900 rounded-lg p-2 shadow focus:outline-none'
                            : 'text-gray-400 hover:text-red-500 transition bg-white hover:bg-red-100 rounded-lg p-2 shadow focus:outline-none'"
                        title="Hapus">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 m-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
            </transition-group>
        </div>
        <!-- Nutrition List, meals hanya untuk tanggal dipilih -->
        <div v-if="currentView === 'nutrition'" class="space-y-4 custom-scrollbar overflow-y-auto max-h-96 pr-2">
            <div v-if="filteredMeals.length === 0"
                :class="darkMode
                    ? 'p-7 bg-gray-800/75 rounded-2xl shadow text-center text-gray-400 text-lg font-semibold border-2 border-dashed border-secondary-700/40'
                    : 'p-7 bg-secondary-50 rounded-2xl shadow text-center text-secondary-400 text-lg font-semibold border-2 border-dashed border-secondary-200'"
            >
                Belum ada input nutrisi untuk tanggal ini üßë‚Äçüç≥
            </div>
            <transition-group name="fadeY">
            <div v-for="m in filteredMeals" :key="m.id"
                :class="darkMode
                    ? 'bg-gradient-to-l from-secondary-600/5 to-gray-900 p-6 rounded-2xl shadow-lg border-l-8 border-secondary-500 flex justify-between items-center group hover:bg-secondary-900/10 transition'
                    : 'bg-gradient-to-l from-secondary-100/70 to-white p-6 rounded-2xl shadow border-l-8 border-secondary-200 flex justify-between items-center group hover:bg-secondary-100/60 transition'"
            >
                <div class="flex-1 min-w-0">
                    <p :class="darkMode ? 'font-bold text-lg text-white truncate' : 'font-bold text-lg text-secondary-900 truncate'">{{ m.description }}</p>
                    <p :class="darkMode ? 'text-sm text-secondary-300 font-medium' : 'text-sm text-secondary-700 font-medium'">{{ m.calories }} kcal / {{ m.protein }} g Protein</p>
                </div>
                <button @click="deleteItem('meals', m.id)"
                    :class="darkMode
                        ? 'text-gray-500 hover:text-red-500 transition bg-gray-800 hover:bg-red-900 rounded-lg p-2 shadow focus:outline-none'
                        : 'text-gray-400 hover:text-red-500 transition bg-white hover:bg-red-100 rounded-lg p-2 shadow focus:outline-none'"
                    title="Hapus">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 m-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
            </transition-group>
        </div>
    </section>
</div>
<script type="module">
    import "https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js";
    import 'https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js';
    let data = await fetch('./loading.js').then(res=>res.text());
    const firebaseConfig = JSON.parse(data);

    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore();

    const userId = 'anon_user';
    const appId = firebaseConfig.projectId || 'testing-54719';

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentView: 'financial', // 'financial' or 'nutrition'
                isLoading: false,
                darkMode: false,
                selectedDate: new Date().toISOString().substring(0, 10),
                apiError: null,
                transactions: [],
                meals: [],
                newTransaction: { description: '', amount: null, category: '' },
                newMeal: { description: '', calories: null, protein: null, source: 'Manual' },
                imageFile: null,
                imagePreviewUrl: null,
                analysisResult: { calories: null, protein: null, description: '' },
                chartFinDonut: null,
                chartFinBar: null,
                chartNutProtein: null,
                chartNutCalorie: null,
                monthlyFinancialTarget: 4500000,
            };
        },
        computed: {
            filteredTransactions() {
                return this.transactions
                    .filter(t => t.date === this.selectedDate)
                    .sort((a, b) => b.timestamp - a.timestamp);
            },
            filteredMeals() {
                return this.meals
                    .filter(m => m.date === this.selectedDate)
                    .sort((a, b) => b.timestamp - a.timestamp);
            },
            totalDailyExpense() {
                return this.filteredTransactions.reduce((sum, t) => sum + t.amount, 0);
            },
            totalDailyNutrition() {
                return {
                    calories: this.filteredMeals.reduce((sum, m) => sum + m.calories, 0),
                    protein: this.filteredMeals.reduce((sum, m) => sum + m.protein, 0)
                };
            },
            // baru: total pengeluaran sebulan (month/year yang sama dgn selectedDate)
            totalMonthlyExpense() {
                const month = this.selectedDate.substring(0, 7);
                return this.transactions
                    .filter(t => (t.date || '').substring(0, 7) === month)
                    .reduce((sum, t) => sum + t.amount, 0);
            },
            bulkingGoalStatus() {
                const totalCal = this.totalDailyNutrition.calories;
                const totalProt = this.totalDailyNutrition.protein;
                const calTargetMet = totalCal >= 2000 && totalCal <= 2600;
                const protTargetMet = totalProt >= 94 && totalProt <= 130;
                let message = '';
                let className = this.darkMode ? 'bg-gray-700 text-gray-300' : 'bg-secondary-50 text-secondary-700';
                if (calTargetMet && protTargetMet) {
                    message = 'üéâ Target Bulking Harian TERCAPAI! Nutrisi seimbang.';
                    className = this.darkMode
                        ? 'bg-secondary-500/20 text-secondary-300 border border-secondary-500'
                        : 'bg-green-100 text-green-800 border border-green-400';
                } else if (totalCal < 2000) {
                    message = '‚ö†Ô∏è Kalori Harian Rendah. Perlu menambah asupan kalori untuk Bulking.';
                    className = this.darkMode
                        ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500'
                        : 'bg-yellow-100 text-yellow-800 border border-yellow-400';
                } else if (totalProt < 94) {
                    message = '‚ö†Ô∏è Protein Harian Rendah. Tingkatkan asupan protein.';
                    className = this.darkMode
                        ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500'
                        : 'bg-yellow-100 text-yellow-800 border border-yellow-400';
                } else if (totalCal > 2600) {
                    message = '‚ö†Ô∏è Kalori Harian Tinggi. Perhatikan risiko penumpukan lemak.';
                    className = this.darkMode
                        ? 'bg-red-500/20 text-red-300 border border-red-500'
                        : 'bg-red-100 text-red-800 border border-red-400';
                } else {
                    message = 'Tinjau kebutuhan Kalori (2000-2300) dan Protein (94-130g) Anda.';
                    className = this.darkMode
                        ? 'bg-gray-700 text-gray-300'
                        : 'bg-secondary-50 text-secondary-700';
                }
                return { message, class: className };
            },
            // Untuk nampilkan summary bulan yang dipilih
            formattedMonth() {
                return (date) => {
                    const options = { year: 'numeric', month: 'long' };
                    return new Date(date).toLocaleDateString('id-ID', options);
                };
            }
        },
        watch: {
            selectedDate() { this.fetchData(); },
            currentView() {
                this.$nextTick(() => this.updateCharts());
            },
            darkMode(val) {
                // sync <body> class with darkMode
                document.documentElement.classList.toggle('dark', !!val);
            }
        },
        methods: {
            toggleDarkMode() {
                this.darkMode = !this.darkMode;
                document.documentElement.classList.toggle('dark', this.darkMode);
                localStorage.setItem("darkMode", this.darkMode ? "true" : "false");
                // Re-render Charts with theme
                this.updateCharts();
            },
            switchView(view) {
                this.currentView = view;
            },
            formattedDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('id-ID', options);
            },
            getBasePath(collectionName) {
                return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
            },
            async fetchData() {
                if (!db || !userId) return;
                this.isLoading = true;
                try {
                    const transactionsRef = this.getBasePath('transactions');
                    const transactionsSnapshot = await transactionsRef.get();
                    this.transactions = transactionsSnapshot.docs.map(
                        doc => ({ id: doc.id, ...doc.data(), amount: Number(doc.data().amount) })
                    );
                    const mealsRef = this.getBasePath('meals');
                    const mealsSnapshot = await mealsRef.get();
                    this.meals = mealsSnapshot.docs.map(
                        doc => ({ id: doc.id, ...doc.data(), calories: Number(doc.data().calories), protein: Number(doc.data().protein) })
                    );
                    // Update chart setelah data diambil
                    this.updateCharts();
                } catch (e) {
                    console.error("Error fetching data: ", e);
                } finally {
                    this.isLoading = false;
                }
            },
            async saveTransaction() {
                if (!db || !this.newTransaction.description || this.newTransaction.amount === null || !this.newTransaction.category) return;
                const transactionData = {
                    ...this.newTransaction,
                    amount: Number(this.newTransaction.amount),
                    date: this.selectedDate,
                    timestamp: new Date().getTime(),
                    userId: userId,
                };
                try {
                    const docRef = await this.getBasePath('transactions').add(transactionData);
                    this.transactions.push({ id: docRef.id, ...transactionData });
                    this.newTransaction = { description: '', amount: null, category: '' };
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            },
            async saveMeal() {
                if (!db || !this.newMeal.description || this.newMeal.calories === null || this.newMeal.protein === null) return;
                const mealData = {
                    ...this.newMeal,
                    calories: Number(this.newMeal.calories),
                    protein: Number(this.newMeal.protein),
                    date: this.selectedDate,
                    timestamp: new Date().getTime(),
                    userId: userId,
                };
                try {
                    const docRef = await this.getBasePath('meals').add(mealData);
                    this.meals.push({ id: docRef.id, ...mealData });
                    this.newMeal = { description: '', calories: null, protein: null, source: 'Manual' };
                    this.updateCharts()
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            },
            quickSaveMeal() {
                if (!db || !this.analysisResult.description || !this.analysisResult.calories) {
                    alert('Hasil analisis AI belum lengkap.');
                    return;
                }
                this.newMeal.description = `AI Analisis: ${this.analysisResult.description}`;
                this.newMeal.calories = this.analysisResult.calories;
                this.newMeal.protein = this.analysisResult.protein;
                this.newMeal.source = 'AI-Image';
                this.saveMeal().then(() => {
                    this.analysisResult = { calories: null, protein: null, description: '' };
                    this.clearImage();
                });
            },
            async deleteItem(collectionName, itemId) {
                if (!db || !confirm('Yakin ingin menghapus item ini?')) return;
                try {
                    await this.getBasePath(collectionName).doc(itemId).delete();
                    if (collectionName === 'transactions') {
                        this.transactions = this.transactions.filter(t => t.id !== itemId);
                    } else if (collectionName === 'meals') {
                        this.meals = this.meals.filter(m => m.id !== itemId);
                    }
                    this.updateCharts()
                } catch (e) {
                    console.error("Error removing document: ", e);
                }
            },
            // --- AI IMAGE ANALYSIS ---
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.imageFile = file;
                    this.imagePreviewUrl = URL.createObjectURL(file);
                    this.analysisResult = { calories: null, protein: null, description: '' };
                    this.apiError = null;
                }
            },
            clearImage() {
                this.imageFile = null;
                this.imagePreviewUrl = null;
                document.querySelector('input[type="file"]').value = null;
            },
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            },
            async startImageAnalysis() {
                if (!this.imageFile) return;
                const base64Image = await this.fileToBase64(this.imageFile);
                this.isLoading = true;
                this.apiError = null;
                this.analysisResult = { calories: null, protein: null, description: '' };
                const HYPRLAB_API_KEY = "hypr-lab-iy2GCzjMlmjZw8xmtDdhT3BlbkFJp9e4wcyjw3PpyVJGI754"; 
                const userPrompt = `Analisis makanan dalam gambar ini dan berikan objek JSON ringkas yang berisi total perkiraan kalori (kcal) dan protein (g), serta deskripsi singkat makanan tersebut. FORMAT OUTPUT HARUS BERUPA SATU JSON STRING: {\"calories\": <number>, \"protein\": <number>, \"description\": \"<text>\"}. Berikan nilai 0 jika tidak yakin.`;
                const apiUrl = "https://api.hyprlab.io/v1/chat/completions";
                const payload = {
                    model: "gpt-5-nano",
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: userPrompt },
                            { type: "image_url", image_url: { url: base64Image } }
                        ]
                    }],
                    response_format: { type: "json_object" } 
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${HYPRLAB_API_KEY}`
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    const aiText = result.choices[0].message.content.trim();
                    let jsonText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsedJson = JSON.parse(jsonText);
                    this.analysisResult.calories = Math.round(parsedJson.calories || 0);
                    this.analysisResult.protein = Math.round(parsedJson.protein || 0);
                    this.analysisResult.description = parsedJson.description || 'Makanan terdeteksi';
                } catch (e) {
                    console.error("AI Analysis Error:", e);
                    this.apiError = `Gagal menganalisis gambar. Pesan: ${e.message}. Pastikan Kunci API Hyprlab benar.`;
                } finally {
                    this.isLoading = false;
                }
            },
            // --- Chart Logic ---
            updateCharts() {
                // Destroy ALL charts before redraw
                if (this.chartFinDonut) {
                    this.chartFinDonut.destroy();
                    this.chartFinDonut = null;
                }
                if (this.chartFinBar) {
                    this.chartFinBar.destroy();
                    this.chartFinBar = null;
                }
                if (this.chartNutProtein) {
                    this.chartNutProtein.destroy();
                    this.chartNutProtein = null;
                }
                if (this.chartNutCalorie) {
                    this.chartNutCalorie.destroy();
                    this.chartNutCalorie = null;
                }
                this.$nextTick(() => {
                    if (this.currentView === 'financial') {
                        // Donut: sisa, terpakai
                        const totalUsed = this.totalMonthlyExpense;
                        const totalTarget = this.monthlyFinancialTarget;
                        let usedPercent = Math.min(totalUsed, totalTarget);
                        let remain = Math.max(totalTarget - totalUsed, 0);
                        let over = totalUsed > totalTarget ? totalUsed - totalTarget : 0;
                        let donutSeries = over > 0
                            ? [totalTarget, over]
                            : [usedPercent, remain];
                        let donutLabels = over > 0
                            ? ['Sesuai Target', 'Melebihi Target']
                            : ['Terpakai', 'Sisa Target'];
                        let donutColors = over > 0
                            ? ['#3b82f6', '#ef4444']
                            : ['#3b82f6', '#10b981'];
                        const themeMode = this.darkMode ? 'dark' : 'light';
                        const donutOptions = {
                            chart: { type: 'donut', height: 320, background: this.darkMode ? '#1f2937' : '#fff', toolbar: { show: false } },
                            theme: { mode: themeMode },
                            labels: donutLabels,
                            series: donutSeries,
                            colors: donutColors,
                            plotOptions: {
                                pie: {
                                    donut: {
                                        size: '75%',
                                        labels: {
                                            show: true,
                                            name: { show: true, color: this.darkMode ? '#e5e7eb' : '#0c2633', fontSize: '1.25rem' },
                                            value: { show: true, color: this.darkMode ? '#e5e7eb' : '#0c2633', fontSize: '1.5rem', formatter: v => `Rp ${Number(v).toLocaleString('id-ID')}` },
                                            total: {
                                                show: true,
                                                label: 'Total',
                                                color: this.darkMode ? '#d1d5db' : '#7d9cac',
                                                formatter: function(w) {
                                                    return `Rp ${(totalTarget).toLocaleString('id-ID')}`;
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            tooltip: { y: { formatter: v => `Rp ${Number(v).toLocaleString('id-ID')}` } },
                            legend: { labels: { colors: this.darkMode ? '#9ca3af' : '#2c3c4b' } }
                        };
                        const elDonut = document.querySelector("#apexChartFinDonut");
                        if (elDonut) {
                            this.chartFinDonut = new ApexCharts(elDonut, donutOptions);
                            this.chartFinDonut.render();
                        }
                        // Bar: pengeluaran harian
                        const month = this.selectedDate.substring(0, 7);
                        const daysInMonth = new Date(Number(month.substring(0, 4)), Number(month.substring(5)), 0).getDate();
                        let categories = [];
                        let actual = [];
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dateStr = `${month}-${i.toString().padStart(2, '0')}`;
                            const daily = this.transactions.filter(t => (t.date === dateStr)).reduce((sum, t) => sum + t.amount, 0);
                            categories.push(i + ' ' + new Date(dateStr).toLocaleDateString('id-ID', {month:'short'}));
                            actual.push(daily);
                        }
                        const barOptions = {
                            chart: { type: 'bar', height: 320, background: this.darkMode ? '#1f2937' : '#fff', toolbar: { show: false } },
                            theme: { mode: themeMode },
                            plotOptions: { bar: { horizontal: false, borderRadius: 2 } },
                            stroke: { width: 1, curve: 'smooth' },
                            title: { text: 'Pengeluaran Harian', align: 'left', style: { color: this.darkMode ? '#e5e7eb' : '#214273' } },
                            xaxis: { categories, labels: { style: { colors: this.darkMode ? '#9ca3af' : '#7489a7' } }},
                            yaxis: {
                                title: { text: 'Rp', style: { color: this.darkMode ? '#f87171' : '#d42037' }},
                                labels: {formatter: (val) => `Rp${Math.round(val/1000)}k`, style: { colors: this.darkMode ? '#f87171' : '#d42037'}}
                            },
                            series: [
                                { name: 'Aktual', data: actual }
                            ],
                            colors: [this.darkMode ? '#3b82f6' : '#2563eb'],
                            tooltip: { theme: themeMode, y: {formatter: val => `Rp ${val.toLocaleString('id-ID')}`}},
                            legend: { labels: { colors: this.darkMode ? '#9ca3af' : '#214273' } }
                        };
                        const elBar = document.querySelector("#apexChartFinBar");
                        if (elBar) {
                            this.chartFinBar = new ApexCharts(elBar, barOptions);
                            this.chartFinBar.render();
                        }
                    } else {
                        // Nutrition: Split charts per target vs actual for Protein and Calorie
                        const month = this.selectedDate.substring(0, 7);
                        const daysInMonth = new Date(Number(month.substring(0, 4)), Number(month.substring(5)), 0).getDate();
                        let categories = [], calPerDay = [], protPerDay = [];
                        let calTargetLow = [], calTargetHigh = [], protTargetLow = [], protTargetHigh = [];
                        // Nutrition target
                        const calLow = 2000, calHigh = 2300;
                        const protLow = 94, protHigh = 130;
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dateStr = `${month}-${i.toString().padStart(2, '0')}`;
                            categories.push(i + ' ' + new Date(dateStr).toLocaleDateString('id-ID', {month:'short'}));
                            const dailyMeals = this.meals.filter(m => m.date === dateStr);
                            calPerDay.push(dailyMeals.reduce((sum, m) => sum + (m.calories||0), 0));
                            protPerDay.push(dailyMeals.reduce((sum, m) => sum + (m.protein||0), 0));
                            calTargetLow.push(calLow);
                            calTargetHigh.push(calHigh);
                            protTargetLow.push(protLow);
                            protTargetHigh.push(protHigh);
                        }
                        // Protein Chart
                        const proteinOpts = {
                            chart: { type: 'line', height: 320, background: this.darkMode ? '#1f2937' : '#fff', toolbar: { show: false } },
                            theme: { mode: this.darkMode ? 'dark' : 'light' },
                            stroke: { width: [3, 2, 2], curve: 'smooth', dashArray: [0,4,4] },
                            markers: { size: 3 },
                            title: { text: 'Trend Protein Harian', align: 'left', style: { color: this.darkMode ? '#e5e7eb' : '#0d692d' } },
                            xaxis: { categories, labels: { style: { colors: this.darkMode ? '#9ca3af': '#348152'} } },
                            yaxis: {
                                title: { text: 'Protein (g)', style: { color: this.darkMode ? '#f97316': '#0d692d'} },
                                labels: { style: { colors: this.darkMode ? '#f97316' : '#0d692d'} }
                            },
                            series: [
                                { name: 'Aktual Protein', type: 'line', data: protPerDay, color: this.darkMode ? '#f97316':'#16a34a'},
                                { name: 'Target Min', type: 'line', data: protTargetLow, color: '#22d3ee' },
                                { name: 'Target Maks', type: 'line', data: protTargetHigh, color: '#06b6d4' },
                            ],
                            tooltip: {
                                theme: this.darkMode ? 'dark' : 'light',
                                y: { formatter: val => `${val} g` }
                            },
                            legend: { labels: { colors: this.darkMode ? '#9ca3af' : '#16a34a' } }
                        };
                        const elProt = document.querySelector("#apexChartProtein");
                        if (elProt) {
                            this.chartNutProtein = new ApexCharts(elProt, proteinOpts);
                            this.chartNutProtein.render();
                        }
                        // Calorie Chart
                        const calOpts = {
                            chart: { type: 'line', height: 320, background: this.darkMode ? '#1f2937' : '#fff', toolbar: { show: false } },
                            theme: { mode: this.darkMode ? 'dark' : 'light' },
                            stroke: { width: [3, 2, 2], curve: 'smooth', dashArray: [0,4,4] },
                            markers: { size: 3 },
                            title: { text: 'Trend Kalori Harian', align: 'left', style: { color: this.darkMode ? '#e5e7eb' : '#2563eb' } },
                            xaxis: { categories, labels: { style: { colors: this.darkMode ? '#9ca3af' : '#2563eb'} } },
                            yaxis: {
                                title: { text: 'Kalori (kcal)', style: { color: this.darkMode ? '#10b981' : '#2563eb' } },
                                labels: { style: { colors: this.darkMode ? '#10b981' : '#2563eb' } }
                            },
                            series: [
                                { name: 'Aktual Kalori', type: 'line', data: calPerDay, color: this.darkMode ? '#10b981': '#3b82f6' },
                                { name: 'Target Min', type: 'line', data: calTargetLow, color: '#fcd34d' },
                                { name: 'Target Maks', type: 'line', data: calTargetHigh, color: '#fde68a' },
                            ],
                            tooltip: {
                                theme: this.darkMode ? 'dark' : 'light',
                                y: { formatter: val => `${val} kcal` }
                            },
                            legend: { labels: { colors: this.darkMode ? '#9ca3af' : '#2563eb' } }
                        };
                        const elCal = document.querySelector("#apexChartCalorie");
                        if (elCal) {
                            this.chartNutCalorie = new ApexCharts(elCal, calOpts);
                            this.chartNutCalorie.render();
                        }
                    }
                });
            }
        },
        mounted() {
            // Load theme from localStorage or auto
            const ls = localStorage.getItem("darkMode");
            if (ls === "true") {
                this.darkMode = true;
                document.documentElement.classList.add('dark');
            } else if (ls === "false") {
                this.darkMode = false;
                document.documentElement.classList.remove('dark');
            } else {
                // Use prefers-color-scheme
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                this.darkMode = prefersDark;
                document.documentElement.classList.toggle('dark', prefersDark);
            }

            if (this.selectedDate === '') {
                this.selectedDate = new Date().toISOString().substring(0, 10);
            }
            this.fetchData();
        }
    }).mount('#app');
</script>
</body>
</html>